================================================================================
CONFIGURATION WEBHOOK MICROSOFT GRAPH - INSTRUCTIONS
================================================================================

√âtape 1 : D√âMARRER LE SERVEUR (Terminal 1)
-------------------------------------------

cd C:\Users\PPZ\NOVA-SERVER
python main.py

Attendez ces logs :
  [INFO] Webhooks routes registered at /api/webhooks
  [INFO] EmailAnalysisDB initialized
  [INFO] Application startup complete
  [INFO] Uvicorn running on http://0.0.0.0:8001

‚ö†Ô∏è LAISSEZ CE TERMINAL OUVERT


√âtape 2 : ENREGISTRER LE WEBHOOK (Terminal 2 - NOUVEAU)
--------------------------------------------------------

Ouvrir un NOUVEAU terminal PowerShell/CMD et ex√©cuter :

cd C:\Users\PPZ\NOVA-SERVER
python register_webhook.py


Ce qui va se passer :
---------------------

1. Le script appelle Microsoft Graph API
2. Microsoft valide l'URL du webhook (envoie une requ√™te de test)
3. Votre serveur r√©pond (logs dans Terminal 1)
4. Microsoft confirme et retourne Subscription ID
5. Script sauvegarde dans webhooks.db


Logs attendus dans Terminal 1 (serveur) :
------------------------------------------

[INFO] üìû Webhook validation request received
[INFO] Webhook subscription created: 12345678-abcd-...


Output attendu dans Terminal 2 (script) :
------------------------------------------

================================================================================
REGISTRATION WEBHOOK MICROSOFT GRAPH
================================================================================

Resource: me/mailFolders('Inbox')/messages
Change Type: created
Notification URL: https://nova-rondot.itspirit.ovh/api/webhooks/notification

[INFO] Creating subscription...

[OK] Webhook registered successfully!

Subscription ID: 12345678-abcd-1234-5678-123456789abc
Resource: me/mailFolders('Inbox')/messages
Change Type: created
Expiration: 2026-02-16T13:00:00Z


√âtape 3 : TESTER LE WEBHOOK
----------------------------

1. Envoyer un email TEST √† votre bo√Æte mail configur√©e
   (depuis un autre compte, pas depuis le m√™me compte)

2. Observer Terminal 1 (serveur) - Logs attendus :

   [INFO] üì¨ Webhook notification received
   [INFO] üîÑ Processing notification: created on ...
   [INFO] üìß New email detected: AAMk...abc123
   [INFO] ü§ñ Auto-processing email: AAMk...abc123
   [INFO] üìß Email: Test devis from client@example.com
   [INFO] ‚úÖ Quote request detected
   [INFO] üí∞ Calcul pricing pour X produits...
   [INFO] ‚úÖ Auto-processing completed
   [INFO] üíæ Analysis persisted to DB

3. Acc√©der √† l'interface web :
   https://nova-rondot.itspirit.ovh/

4. Charger bo√Æte de r√©ception

5. L'email doit avoir le bouton "Synth√®se" (d√©j√† trait√©)

6. Clic "Synth√®se" ‚Üí Affichage instantan√© !


ERREURS POSSIBLES
------------------

Erreur : "Failed to validate notificationUrl"
  ‚Üí Le serveur (Terminal 1) n'est pas accessible depuis Internet
  ‚Üí V√©rifier firewall/reverse proxy Caddy
  ‚Üí V√©rifier que https://nova-rondot.itspirit.ovh/ fonctionne

Erreur : "Insufficient privileges"
  ‚Üí Permissions Microsoft Graph manquantes
  ‚Üí Ajouter Mail.Read dans Azure AD

Erreur : "Access token has expired"
  ‚Üí V√©rifier GRAPH_CLIENT_ID, GRAPH_CLIENT_SECRET dans .env


RENOUVELLEMENT AUTOMATIQUE (Apr√®s succ√®s)
------------------------------------------

Le webhook expire apr√®s 3 jours. Pour le renouveler automatiquement :

Windows Task Scheduler :
  1. Ouvrir "Planificateur de t√¢ches"
  2. Cr√©er une t√¢che de base
  3. Nom : NOVA Webhook Renewal
  4. D√©clencheur : Quotidien √† 09:00
  5. Action : D√©marrer un programme
     - Programme : python
     - Arguments : renew_webhook.py
     - Dossier : C:\Users\PPZ\NOVA-SERVER


V√âRIFICATIONS
-------------

Lister webhooks actifs :
  curl http://localhost:8001/api/webhooks/subscriptions

V√©rifier DB :
  sqlite3 webhooks.db "SELECT * FROM subscriptions"

Consulter analyses auto :
  sqlite3 email_analysis.db "SELECT email_id, subject, analyzed_at FROM email_analysis ORDER BY analyzed_at DESC LIMIT 10"


================================================================================
AIDE
================================================================================

Documentation compl√®te : WEBHOOK_CONFIGURATION_GUIDE.md

En cas de probl√®me, fournir :
  - Logs Terminal 1 (serveur)
  - Output Terminal 2 (script register_webhook.py)
  - Contenu .env (masquer secrets)
