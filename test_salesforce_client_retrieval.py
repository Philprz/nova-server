# Test de la m√©thode de r√©cup√©ration client Salesforce
# Fichier: test_salesforce_client_method.py

import asyncio
import sys
import os
from datetime import datetime

# Ajout du chemin parent pour importer les modules
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from managers.client_manager import ClientManager
from services.mcp_connector import MCPConnector
import logging

# Configuration logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class SalesforceClientRetrievalTest:
    """Test unitaire pour la r√©cup√©ration client Salesforce"""
    
    def __init__(self):
        self.mcp_connector = MCPConnector()
        self.client_manager = ClientManager()
        self.test_results = []
    
    async def test_salesforce_connection(self):
        """Test de connexion Salesforce"""
        logger.info("üîç Test connexion Salesforce...")
        
        try:
            result = await self.mcp_connector.test_connections()
            
            sf_status = result.get("salesforce", {})
            if sf_status.get("success", False):
                logger.info("‚úÖ Connexion Salesforce OK")
                return True
            else:
                # AM√âLIORATION : Diagnostic d√©taill√©
                error_detail = sf_status.get("error", "Erreur inconnue")
                logger.error(f"‚ùå Connexion Salesforce √©chou√©e: {error_detail}")
                
                # Test alternatif direct
                test_query = "SELECT Id, Name FROM Account LIMIT 1"
                direct_test = await self.mcp_connector.call_salesforce_mcp("salesforce_query", {"query": test_query})
                
                if "error" not in direct_test and direct_test.get("records"):
                    logger.info("‚úÖ Test direct Salesforce r√©ussi - connexion fonctionnelle")
                    return True
                
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Exception test connexion: {str(e)}")
            return False
    
    async def test_direct_soql_query(self):
        """Test requ√™te SOQL directe"""
        logger.info("üîç Test requ√™te SOQL directe...")
        
        try:
            # Requ√™te simple pour r√©cup√©rer quelques comptes
            query = """
                SELECT Id, Name, AccountNumber, Phone,  
                       BillingCity, BillingCountry, CreatedDate
                FROM Account 
                LIMIT 5
            """
            
            result = await self.mcp_connector.call_salesforce_mcp("salesforce_query", {"query": query})
            
            if "error" not in result and result.get("records"):
                records_count = len(result.get("records", []))
                logger.info(f"‚úÖ Requ√™te SOQL r√©ussie: {records_count} enregistrements")
                
                # Afficher les d√©tails du premier enregistrement
                if records_count > 0:
                    first_record = result["records"][0]
                    logger.info(f"Premier enregistrement: {first_record.get('Name')} (ID: {first_record.get('Id')})")
                
                return True
            else:
                error = result.get("error", "Aucun enregistrement trouv√©")
                logger.error(f"‚ùå Requ√™te SOQL √©chou√©e: {error}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Exception requ√™te SOQL: {str(e)}")
            return False
    
    async def test_client_search_by_name(self, client_name: str = "Edge"):
        """Test recherche client par nom"""
        logger.info(f"üîç Test recherche client: {client_name}")
        
        try:
            # Utiliser la m√©thode _search_salesforce_client du ClientManager
            result = await self.client_manager._search_salesforce_client(client_name)
            
            if result.get("found"):
                client_data = result.get("data", {})
                logger.info(f"‚úÖ Client trouv√©: {client_data.get('Name')} (ID: {client_data.get('Id')})")
                logger.info(f"   Ville: {client_data.get('BillingCity', 'N/A')}")
                logger.info(f"   T√©l√©phone: {client_data.get('Phone', 'N/A')}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è Client '{client_name}' non trouv√©")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Exception recherche client: {str(e)}")
            return False
    
    async def test_client_search_with_special_chars(self):
        """Test recherche avec caract√®res sp√©ciaux"""
        logger.info("üîç Test recherche avec caract√®res sp√©ciaux...")
        
        test_names = [
            "D'Artagnan & Co",
            "L'Entreprise",
            "soci√©t√©-test"
        ]
        
        success_count = 0
        for name in test_names:
            try:
                result = await self.client_manager._search_salesforce_client(name)
                # M√™me si non trouv√©, l'important est qu'il n'y ait pas d'erreur
                if "error" not in result:
                    success_count += 1
                    logger.info(f"‚úÖ Recherche '{name}' sans erreur")
                else:
                    logger.error(f"‚ùå Erreur recherche '{name}': {result.get('error')}")
                    
            except Exception as e:
                logger.error(f"‚ùå Exception recherche '{name}': {str(e)}")
        
        return success_count == len(test_names)
    
    async def test_client_manager_search_method(self):
        """Test m√©thode search_client du ClientManager"""
        logger.info("üîç Test m√©thode ClientManager.search_client...")
        
        try:
            # Test avec un nom g√©n√©rique
            result = await self.client_manager.search_client("Communications")
            
            if result.get("found"):
                source = result.get("source", "unknown")
                client_name = result.get("data", {}).get("Name", "N/A")
                logger.info(f"‚úÖ Client trouv√© via {source}: {client_name}")
                return True
            elif "suggestions" in result:
                suggestions_count = len(result.get("suggestions", []))
                logger.info(f"‚ö†Ô∏è Client non trouv√©, {suggestions_count} suggestions g√©n√©r√©es")
                return True  # Les suggestions sont aussi un succ√®s
            else:
                logger.warning("‚ö†Ô∏è Aucun r√©sultat ni suggestion")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Exception test ClientManager: {str(e)}")
            return False
    
    async def test_comprehensive_client_data_extraction(self):
        """Test extraction compl√®te des donn√©es client"""
        logger.info("üîç Test extraction donn√©es compl√®tes...")
        
        try:
            # ‚ö†Ô∏è CORRECTION : Supprimer Email, Website non disponible
            query = """
                SELECT Id, Name, AccountNumber, Phone,
                    BillingStreet, BillingCity, BillingPostalCode, BillingCountry, BillingState,
                    ShippingStreet, ShippingCity, ShippingPostalCode, ShippingCountry, ShippingState,
                    Industry, Type, NumberOfEmployees,
                    CreatedDate, LastModifiedDate, Description
                FROM Account 
                WHERE Name != '' 
                LIMIT 3
            """
            
            result = await self.mcp_connector.call_salesforce_mcp("salesforce_query", {"query": query})
            
            if result.get("records"):
                for i, record in enumerate(result["records"]):
                    logger.info(f"üìã Enregistrement {i+1}:")
                    logger.info(f"   Nom: {record.get('Name', 'N/A')}")
                    logger.info(f"   Secteur: {record.get('Industry', 'N/A')}")
                    logger.info(f"   Ville: {record.get('BillingCity', 'N/A')}")
                    logger.info(f"   Pays: {record.get('BillingCountry', 'N/A')}")
                
                logger.info("‚úÖ Extraction donn√©es compl√®tes r√©ussie")
                return True
            else:
                logger.error("‚ùå Aucune donn√©e extraite")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Exception extraction donn√©es: {str(e)}")
            return False
    
    async def run_all_tests(self):
        """Ex√©cuter tous les tests"""
        logger.info("üöÄ D√©but des tests de r√©cup√©ration client Salesforce")
        logger.info("="*60)
        
        tests = [
            ("Connexion Salesforce", self.test_salesforce_connection),
            ("Requ√™te SOQL directe", self.test_direct_soql_query),
            ("Recherche client par nom", self.test_client_search_by_name),
            ("Recherche caract√®res sp√©ciaux", self.test_client_search_with_special_chars),
            ("M√©thode ClientManager", self.test_client_manager_search_method),
            ("Extraction donn√©es compl√®tes", self.test_comprehensive_client_data_extraction)
        ]
        
        passed_tests = 0
        total_tests = len(tests)
        
        for test_name, test_method in tests:
            logger.info(f"\nüìù {test_name}...")
            try:
                success = await test_method()
                if success:
                    passed_tests += 1
                    self.test_results.append(f"‚úÖ {test_name}: PASSED")
                else:
                    self.test_results.append(f"‚ùå {test_name}: FAILED")
            except Exception as e:
                logger.error(f"‚ùå Erreur critique dans {test_name}: {str(e)}")
                self.test_results.append(f"üí• {test_name}: ERROR - {str(e)}")
        
        # R√©sum√© final
        logger.info("\n" + "="*60)
        logger.info("üìä R√âSULTATS DES TESTS")
        logger.info("="*60)
        
        for result in self.test_results:
            logger.info(result)
        
        success_rate = (passed_tests / total_tests) * 100
        logger.info(f"\nüéØ Taux de r√©ussite: {passed_tests}/{total_tests} ({success_rate:.1f}%)")
        
        if success_rate >= 80:
            logger.info("üéâ Tests majoritairement r√©ussis - M√©thode r√©cup√©ration client op√©rationnelle")
        elif success_rate >= 50:
            logger.info("‚ö†Ô∏è Tests partiellement r√©ussis - Am√©liorations n√©cessaires")
        else:
            logger.info("üö® Tests majoritairement √©chou√©s - R√©vision compl√®te requise")
        
        return success_rate >= 80

async def main():
    """Point d'entr√©e principal"""
    tester = SalesforceClientRetrievalTest()
    success = await tester.run_all_tests()
    return success

if __name__ == "__main__":
    try:
        result = asyncio.run(main())
        print(f"\nüèÅ Tests termin√©s - Succ√®s: {result}")
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è Tests interrompus par l'utilisateur")
    except Exception as e:
        print(f"\nüí• Erreur fatale: {str(e)}")