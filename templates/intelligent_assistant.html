<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA - Assistant Intelligent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Layout principal */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            background: white;
            border-radius: 0;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #34495e;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .logo {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tagline {
            font-size: 0.9em;
            opacity: 0.8;
            font-style: italic;
        }

        .quick-actions {
            padding: 20px;
            flex: 1;
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.9em;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: #2980b9;
        }

        .action-btn.primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
        }

        /* Zone de chat principale */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
        }

        .chat-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .chat-subtitle {
            color: #718096;
            font-size: 0.9em;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Zone des messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.nova {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.nova .message-avatar {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.nova .message-content {
            background: white;
            border: 1px solid #e2e8f0;
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-suggestions {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-chip {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(72, 187, 120, 0.2);
        }

        .suggestion-chip:hover {
            background: rgba(72, 187, 120, 0.2);
            transform: translateY(-1px);
        }

        .quick-actions-inline {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-1px);
        }

        /* Zone de saisie */
        .input-container {
            background: white;
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1em;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Indicateur de frappe */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            align-self: flex-start;
            max-width: 80%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Messages d'accueil */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .welcome-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .welcome-examples {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .example-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .example-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .example-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .example-text {
            color: #718096;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }
            
            .chat-container {
                order: 1;
                height: 70vh;
            }
            
            .quick-actions {
                display: none;
            }
            
            .messages-container {
                padding: 15px 20px;
            }
            
            .input-container {
                padding: 15px 20px;
            }
        }

        /* Animations d'entr√©e */
        .message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar personnalis√©e */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    üöÄ NOVA
                </div>
                <div class="tagline">Assistant Intelligent</div>
            </div>
            
            <div class="quick-actions">
                <h3>üöÄ Actions Rapides</h3>
                <button class="action-btn primary" onclick="startNewQuoteWorkflow()">
                    üìù Nouveau Devis
                </button>
                <button class="action-btn" onclick="openClientSearch()">
                    üë• Rechercher Client
                </button>
                <button class="action-btn" onclick="openProductSearch()">
                    üì¶ Produits
                </button>
                <button class="action-btn" onclick="sendQuickMessage('Aide')">
                    ‚ùì Aide
                </button>
                
                <h3 style="margin-top: 30px;">üìä Raccourcis</h3>
                <a href="/static/nova_interface.html" class="action-btn">
                    üîß Interface Classique
                </a>
                <a href="/static/sync_dashboard.html" class="action-btn">
                    üîÑ Synchronisation
                </a>
                <button class="action-btn" onclick="clearConversation()">
                    üóëÔ∏è Effacer Discussion
                </button>
            </div>
        </div>

        <!-- Zone de chat principale -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <span class="status-indicator"></span>
                    Conversation avec NOVA
                </div>
                <div class="chat-subtitle">
                    Assistant intelligent pour la g√©n√©ration de devis
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <!-- Message d'accueil -->
                <div class="welcome-message">
                    <div class="welcome-title">üëã Bonjour ! Je suis NOVA</div>
                    <p>Votre assistant intelligent pour la g√©n√©ration de devis.<br>
                    Dites-moi simplement ce que vous voulez faire !</p>
                    
                    <div class="welcome-examples">
                        <div class="example-card" onclick="sendQuickMessage('Cr√©er un devis pour Edge Communications')">
                            <div class="example-title">üìù Cr√©er un devis</div>
                            <div class="example-text">"Cr√©er un devis pour Edge Communications"</div>
                        </div>
                        <div class="example-card" onclick="sendQuickMessage('Chercher le client Acme Corp')">
                            <div class="example-title">üîç Rechercher</div>
                            <div class="example-text">"Chercher le client Acme Corp"</div>
                        </div>
                        <div class="example-card" onclick="sendQuickMessage('Produit A00025 disponible ?')">
                            <div class="example-title">üì¶ V√©rifier stock</div>
                            <div class="example-text">"Produit A00025 disponible ?"</div>
                        </div>
                    </div>
                </div>

                <!-- Indicateur de frappe -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">ü§ñ</div>
                    <div>
                        NOVA r√©fl√©chit
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="input-field" 
                        placeholder="Tapez votre message... (Ex: 'Cr√©er un devis pour Edge Communications')"
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="adjustTextareaHeight(this)"
                    ></textarea>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let conversationHistory = [];
        let isWaitingForResponse = false;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ NOVA Assistant Intelligent initialis√©');
            loadConversationHistory();
        });

        // Gestion de l'envoi de messages
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isWaitingForResponse) return;
            
            // Afficher le message utilisateur
            addMessage('user', message);
            
            // Vider le champ de saisie
            input.value = '';
            adjustTextareaHeight(input);
            
            // Envoyer √† NOVA
            sendToNova(message);
        }

        // Envoi rapide de messages pr√©d√©finis
        function sendQuickMessage(message) {
            if (isWaitingForResponse) return;
            
            addMessage('user', message);
            sendToNova(message);
        }

        // Communication avec l'API NOVA
        async function sendToNova(message) {
            isWaitingForResponse = true;
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/assistant/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideTypingIndicator();
                    addNovaMessage(data.response);
                } else {
                    hideTypingIndicator();
                    addMessage('nova', `‚ùå Erreur: ${data.error}`);
                }
                
            } catch (error) {
                console.error('Erreur communication NOVA:', error);
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur de communication avec NOVA. Veuillez r√©essayer.');
            }
            
            isWaitingForResponse = false;
        }

        // Ajouter un message √† la conversation
        function addMessage(sender, content, suggestions = [], quickActions = []) {
            const container = document.getElementById('messagesContainer');
            const welcomeMessage = container.querySelector('.welcome-message');
            
            // Masquer le message d'accueil apr√®s le premier message
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = content;
            
            messageContent.appendChild(messageText);
            
            // Ajouter les suggestions si pr√©sentes
            if (suggestions && suggestions.length > 0) {
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.className = 'message-suggestions';
                
                suggestions.forEach(suggestion => {
                    const chip = document.createElement('span');
                    chip.className = 'suggestion-chip';
                    chip.textContent = suggestion;
                    chip.onclick = () => sendQuickMessage(suggestion);
                    suggestionsDiv.appendChild(chip);
                });
                
                messageContent.appendChild(suggestionsDiv);
            }
            
            // Ajouter les actions rapides si pr√©sentes
            if (quickActions && quickActions.length > 0) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'quick-actions-inline';
                
                quickActions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-action-btn';
                    btn.textContent = action.label;
                    btn.onclick = () => handleQuickAction(action.action);
                    actionsDiv.appendChild(btn);
                });
                
                messageContent.appendChild(actionsDiv);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            container.appendChild(messageDiv);
            
            // Scroll vers le bas
            container.scrollTop = container.scrollHeight;
            
            // Sauvegarder dans l'historique
            conversationHistory.push({
                sender: sender,
                content: content,
                timestamp: new Date().toISOString(),
                suggestions: suggestions,
                quickActions: quickActions
            });
        }

        // Ajouter une r√©ponse NOVA avec formatage sp√©cial
        function addNovaMessage(response) {
            const suggestions = response.suggestions || [];
            const quickActions = response.quick_actions || [];
            
            addMessage('nova', response.message, suggestions, quickActions);
        }

        // Gestion des actions rapides
        function handleQuickAction(action) {
            switch(action) {
                case 'new_quote':
                    sendQuickMessage('Cr√©er un nouveau devis');
                    break;
                case 'show_clients':
                    loadClientsList();
                    break;
                case 'show_products':
                    loadProductsList();
                    break;
                case 'help':
                    sendQuickMessage('Aide');
                    break;
                case 'confirm_quote':
                    sendQuickMessage('Confirmer le devis');
                    break;
                case 'edit_quote':
                    sendQuickMessage('Modifier le devis');
                    break;
                case 'search_more':
                    sendQuickMessage('Rechercher plus d\'options');
                    break;
                // Nouvelles actions pour le workflow de devis
                case 'start_workflow':
                    startNewQuoteWorkflow();
                    break;
                case 'analyze_request':
                    sendQuickMessage('Analyser ma demande de devis');
                    break;
                case 'specify_client':
                    sendQuickMessage('Je veux sp√©cifier le client pour le devis');
                    break;
                case 'choose_products':
                    sendQuickMessage('Je veux choisir les produits pour le devis');
                    break;
                case 'open_classic':
                    window.open('/static/nova_interface.html?action=new_quote', '_blank');
                    addMessage('nova', 'üíº Interface classique ouverte dans un nouvel onglet.');
                    break;
                // Nouvelles actions pour la gestion des doublons
                case 'view_duplicates':
                    showDuplicateQuotes();
                    break;
                case 'create_new':
                    confirmCreateNewQuote();
                    break;
                case 'update_existing':
                    showExistingQuotesToUpdate();
                    break;
                case 'create_quote':
                    finalizeQuoteCreation();
                    break;
                case 'retry':
                    startNewQuoteWorkflow();
                    break;
                case 'manual_entry':
                    window.open('/static/nova_interface.html?action=manual_quote', '_blank');
                    addMessage('nova', 'üìù Interface de saisie manuelle ouverte.');
                    break;
                case 'export_pdf':
                    exportQuoteToPDF();
                    break;
                case 'contact_support':
                    addMessage('nova', 'üìû **Support technique :**\n\nPour obtenir de l\'aide, contactez :\n‚Ä¢ Email : support@nova.com\n‚Ä¢ T√©l√©phone : +33 1 23 45 67 89');
                    break;
                default:
                    console.log('Action non reconnue:', action);
            }
        }

        // Indicateur de frappe
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Gestion du clavier
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Ajustement automatique de la hauteur du textarea
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Effacer la conversation
        async function clearConversation() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer la conversation ?')) {
                try {
                    await fetch('/api/assistant/conversation/clear', { method: 'POST' });
                    
                    // Vider l'interface
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = `
                        <div class="welcome-message">
                            <div class="welcome-title">üëã Nouvelle conversation</div>
                            <p>Comment puis-je vous aider aujourd'hui ?</p>
                        </div>
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="message-avatar">ü§ñ</div>
                            <div>
                                NOVA r√©fl√©chit
                                <div class="typing-dots">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    conversationHistory = [];
                    
                } catch (error) {
                    console.error('Erreur lors de l\'effacement:', error);
                }
            }
        }

        // Charger l'historique de conversation
        async function loadConversationHistory() {
            try {
                const response = await fetch('/api/assistant/conversation/history');
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    // Masquer le message d'accueil
                    const welcomeMessage = document.querySelector('.welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.style.display = 'none';
                    }
                    
                    // Restaurer les messages
                    data.history.forEach(msg => {
                        addMessage(msg.sender, msg.content, msg.suggestions || [], msg.quickActions || []);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement historique:', error);
            }
        }

        // ===== NOUVELLES FONCTIONS POUR ACTIONS RAPIDES =====
        
        // D√©marrer le workflow de cr√©ation de devis
        async function startNewQuoteWorkflow() {
            const message = 'Cr√©er un nouveau devis';
            addMessage('user', message);
            showTypingIndicator();
            
            try {
                // Appeler directement le workflow de devis
                const response = await fetch('/api/assistant/workflow/create_quote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success) {
                    // Afficher le message principal
                    addMessage('nova', data.message);
                    
                    // Afficher les avertissements s'il y en a
                    if (data.warnings && data.warnings.length > 0) {
                        const warningsMessage = '‚ö†Ô∏è **Avertissements :**\n' + data.warnings.map(w => `‚Ä¢ ${w}`).join('\n');
                        addMessage('nova', warningsMessage);
                    }
                    
                    // Afficher les actions rapides du workflow
                    if (data.quick_actions && data.quick_actions.length > 0) {
                        addMessage('nova', 'üéØ **Actions disponibles :**', [], data.quick_actions);
                    }
                    
                    // Stocker les donn√©es du workflow pour utilisation ult√©rieure
                    window.currentWorkflowData = data.quote_data;
                    
                } else {
                    addMessage('nova', data.message || '‚ùå Erreur lors de l\'analyse du devis.');
                    
                    // Afficher les actions de r√©cup√©ration
                    if (data.quick_actions && data.quick_actions.length > 0) {
                        addMessage('nova', 'üîÑ **Options de r√©cup√©ration :**', [], data.quick_actions);
                    }
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur de communication. Ouverture de l\'interface classique...');
                window.open('/static/nova_interface.html?action=new_quote', '_blank');
                console.error('Erreur workflow devis:', error);
            }
        }
        
        // Ouvrir la recherche de clients
        async function openClientSearch() {
            addMessage('user', 'Rechercher Client');
            showTypingIndicator();
            
            try {
                // Appeler l'API de recherche de clients
                const response = await fetch('/clients/search_clients_advanced?q=&limit=20');
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success && data.clients && data.clients.length > 0) {
                    let clientsMessage = `üîç **${data.clients.length} clients trouv√©s** (sur ${data.total_found} total):\n\n`;
                    
                    data.clients.slice(0, 10).forEach((client, index) => {
                        clientsMessage += `**${index + 1}. ${client.Name || client.company_name || 'Client sans nom'}**\n`;
                        if (client.Industry) clientsMessage += `   üìä Secteur: ${client.Industry}\n`;
                        if (client.Phone) clientsMessage += `   üìû T√©l: ${client.Phone}\n`;
                        if (client.Email) clientsMessage += `   üìß Email: ${client.Email}\n`;
                        clientsMessage += `\n`;
                    });
                    
                    if (data.clients.length > 10) {
                        clientsMessage += `... et ${data.clients.length - 10} autres clients.\n\n`;
                    }
                    
                    clientsMessage += `üí° **Astuce**: Tapez le nom d'un client pour le rechercher sp√©cifiquement.`;
                    
                    addMessage('nova', clientsMessage);
                } else {
                    addMessage('nova', 'üìã Aucun client trouv√©. Voulez-vous cr√©er un nouveau client ?');
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur lors de la recherche de clients. Veuillez r√©essayer.');
                console.error('Erreur recherche clients:', error);
            }
        }
        
        // Ouvrir la recherche de produits
        async function openProductSearch() {
            addMessage('user', 'Rechercher Produits');
            showTypingIndicator();
            
            try {
                // Appeler l'API de recherche de produits
                const response = await fetch('/products/search_products_advanced?limit=20');
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success && data.products && data.products.length > 0) {
                    let productsMessage = `üõçÔ∏è **${data.products.length} produits trouv√©s** (sur ${data.total_found} total):\n\n`;
                    
                    data.products.slice(0, 10).forEach((product, index) => {
                        productsMessage += `**${index + 1}. ${product.ItemName || product.name || 'Produit sans nom'}**\n`;
                        if (product.ItemCode) productsMessage += `   üè∑Ô∏è R√©f: ${product.ItemCode}\n`;
                        if (product.Price) productsMessage += `   üí∞ Prix: ${product.Price}‚Ç¨\n`;
                        if (product.QuantityOnStock !== undefined) productsMessage += `   üì¶ Stock: ${product.QuantityOnStock}\n`;
                        productsMessage += `\n`;
                    });
                    
                    if (data.products.length > 10) {
                        productsMessage += `... et ${data.products.length - 10} autres produits.\n\n`;
                    }
                    
                    productsMessage += `üí° **Astuce**: Tapez le nom ou la r√©f√©rence d'un produit pour le rechercher sp√©cifiquement.`;
                    
                    addMessage('nova', productsMessage);
                } else {
                    addMessage('nova', 'üì¶ Aucun produit trouv√© dans le catalogue.');
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur lors de la recherche de produits. Veuillez r√©essayer.');
                console.error('Erreur recherche produits:', error);
            }
        }
        
        // ===== FONCTIONS DE GESTION DES DOUBLONS ET ACTIONS AVANC√âES =====
        
        // Afficher les devis en doublon
        function showDuplicateQuotes() {
            if (!window.currentWorkflowData || !window.currentWorkflowData.duplicate_analysis) {
                addMessage('nova', '‚ùå Aucune donn√©e de doublon disponible.');
                return;
            }
            
            const duplicates = window.currentWorkflowData.duplicate_analysis;
            let message = 'üìã **Devis existants d√©tect√©s :**\n\n';
            
            // Devis r√©cents
            if (duplicates.recent_quotes && duplicates.recent_quotes.length > 0) {
                message += 'üïí **Devis r√©cents :**\n';
                duplicates.recent_quotes.forEach((quote, index) => {
                    message += `${index + 1}. Devis #${quote.doc_num} - ${quote.doc_total}‚Ç¨ (${new Date(quote.doc_date).toLocaleDateString()})\n`;
                });
                message += '\n';
            }
            
            // Devis brouillons
            if (duplicates.draft_quotes && duplicates.draft_quotes.length > 0) {
                message += 'üìù **Devis brouillons :**\n';
                duplicates.draft_quotes.slice(0, 5).forEach((quote, index) => {
                    message += `${index + 1}. Brouillon #${quote.doc_num} - ${quote.doc_total}‚Ç¨ (${new Date(quote.doc_date).toLocaleDateString()})\n`;
                });
                if (duplicates.draft_quotes.length > 5) {
                    message += `... et ${duplicates.draft_quotes.length - 5} autres brouillons\n`;
                }
            }
            
            addMessage('nova', message);
            
            // Actions pour g√©rer les doublons
            const duplicateActions = [
                { label: 'üÜï Cr√©er nouveau', action: 'create_new', type: 'primary' },
                { label: '‚úèÔ∏è Modifier existant', action: 'update_existing', type: 'secondary' },
                { label: 'üíº Interface compl√®te', action: 'open_classic', type: 'info' }
            ];
            
            addMessage('nova', 'üéØ **Que souhaitez-vous faire ?**', [], duplicateActions);
        }
        
        // Confirmer la cr√©ation d'un nouveau devis
        function confirmCreateNewQuote() {
            addMessage('user', 'Cr√©er un nouveau devis malgr√© les doublons');
            addMessage('nova', '‚úÖ **Cr√©ation d\'un nouveau devis confirm√©e**\n\nLe nouveau devis sera cr√©√© en ignorant les doublons existants.');
            
            const confirmActions = [
                { label: 'üöÄ Finaliser', action: 'create_quote', type: 'primary' },
                { label: '‚öôÔ∏è Param√®tres', action: 'open_classic', type: 'secondary' }
            ];
            
            addMessage('nova', 'üéØ **Pr√™t √† finaliser ?**', [], confirmActions);
        }
        
        // Afficher les devis existants √† modifier
        function showExistingQuotesToUpdate() {
            if (!window.currentWorkflowData || !window.currentWorkflowData.duplicate_analysis) {
                addMessage('nova', '‚ùå Aucune donn√©e disponible.');
                return;
            }
            
            const duplicates = window.currentWorkflowData.duplicate_analysis;
            let message = '‚úèÔ∏è **Devis modifiables :**\n\n';
            
            // Combiner brouillons et r√©cents
            const modifiableQuotes = [
                ...(duplicates.draft_quotes || []),
                ...(duplicates.recent_quotes || [])
            ].slice(0, 5);
            
            if (modifiableQuotes.length > 0) {
                modifiableQuotes.forEach((quote, index) => {
                    const status = quote.comments && quote.comments.includes('BROUILLON') ? 'üìù Brouillon' : 'üìã R√©cent';
                    message += `**${index + 1}. ${status} #${quote.doc_num}**\n`;
                    message += `   üí∞ Montant: ${quote.doc_total}‚Ç¨\n`;
                    message += `   üìÖ Date: ${new Date(quote.doc_date).toLocaleDateString()}\n\n`;
                });
                
                message += 'üí° **Astuce**: Utilisez l\'interface compl√®te pour modifier un devis sp√©cifique.';
            } else {
                message = '‚ùå Aucun devis modifiable trouv√©.';
            }
            
            addMessage('nova', message);
            
            const updateActions = [
                { label: 'üíº Interface compl√®te', action: 'open_classic', type: 'primary' },
                { label: 'üÜï Cr√©er nouveau', action: 'create_new', type: 'secondary' }
            ];
            
            addMessage('nova', 'üéØ **Actions disponibles :**', [], updateActions);
        }
        
        // Finaliser la cr√©ation du devis
        function finalizeQuoteCreation() {
            addMessage('user', 'Finaliser la cr√©ation du devis');
            addMessage('nova', 'üöÄ **Finalisation du devis en cours...**\n\nLe devis va √™tre cr√©√© avec les informations analys√©es.');
            
            // Simuler la cr√©ation (en r√©alit√©, cela appellerait l'API)
            setTimeout(() => {
                if (window.currentWorkflowData && window.currentWorkflowData.quote_preview) {
                    const preview = window.currentWorkflowData.quote_preview;
                    const client = preview.client || {};
                    const total = preview.total_amount || 0;
                    
                    let successMessage = '‚úÖ **Devis cr√©√© avec succ√®s !**\n\n';
                    successMessage += `**Client :** ${client.name || 'Non sp√©cifi√©'}\n`;
                    successMessage += `**Montant :** ${total}‚Ç¨\n`;
                    successMessage += `**Statut :** Brouillon\n\n`;
                    successMessage += 'üìã Le devis est maintenant disponible dans l\'interface classique.';
                    
                    addMessage('nova', successMessage);
                    
                    const finalActions = [
                        { label: 'üëÄ Voir le devis', action: 'open_classic', type: 'primary' },
                        { label: 'üìÑ Exporter PDF', action: 'export_pdf', type: 'secondary' },
                        { label: 'üÜï Nouveau devis', action: 'start_workflow', type: 'info' }
                    ];
                    
                    addMessage('nova', 'üéØ **Prochaines √©tapes :**', [], finalActions);
                } else {
                    addMessage('nova', '‚ùå Erreur lors de la finalisation. Utilisez l\'interface classique.');
                }
            }, 2000);
        }
        
        // ===== NOUVELLES FONCTIONS POUR CHARGER LES LISTES =====
        
        // Charger la liste compl√®te des clients
        async function loadClientsList() {
            addMessage('user', 'Voir tous les clients');
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/assistant/clients/list');
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success && data.clients && data.clients.length > 0) {
                    let clientsMessage = data.message + '\n\n';
                    
                    // Afficher les 15 premiers clients avec d√©tails
                    data.clients.slice(0, 15).forEach((client, index) => {
                        clientsMessage += `**${index + 1}. ${client.name}**\n`;
                        if (client.type) clientsMessage += `   üè¢ Type: ${client.type}\n`;
                        if (client.industry) clientsMessage += `   üè≠ Secteur: ${client.industry}\n`;
                        if (client.phone) clientsMessage += `   üìû T√©l: ${client.phone}\n`;
                        if (client.website) clientsMessage += `   üåê Site: ${client.website}\n`;
                        clientsMessage += `\n`;
                    });
                    
                    if (data.clients.length > 15) {
                        clientsMessage += `... et ${data.clients.length - 15} autres clients.\n\n`;
                    }
                    
                    clientsMessage += `üí° **Astuce**: Tapez le nom d'un client pour le rechercher sp√©cifiquement.`;
                    
                    addMessage('nova', clientsMessage);
                    
                    // Ajouter des actions rapides
                    const clientActions = [
                        { label: 'üîç Rechercher client', action: 'search_client', type: 'primary' },
                        { label: '‚ûï Nouveau client', action: 'new_client', type: 'secondary' },
                        { label: 'üìã Cr√©er devis', action: 'start_workflow', type: 'info' }
                    ];
                    
                    addMessage('nova', 'üéØ **Actions disponibles :**', [], clientActions);
                    
                } else {
                    addMessage('nova', data.message || 'üë• Aucun client trouv√© dans la base de donn√©es.');
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur lors du chargement des clients. Veuillez r√©essayer.');
                console.error('Erreur chargement clients:', error);
            }
        }
        
        // Charger la liste compl√®te des produits
        async function loadProductsList() {
            addMessage('user', 'Voir tous les produits');
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/assistant/products/list');
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success && data.products && data.products.length > 0) {
                    let productsMessage = data.message + '\n\n';
                    
                    // Afficher les 15 premiers produits avec d√©tails
                    data.products.slice(0, 15).forEach((product, index) => {
                        productsMessage += `**${index + 1}. ${product.name}**\n`;
                        if (product.code) productsMessage += `   üîñ Code: ${product.code}\n`;
                        if (product.description) productsMessage += `   üìù Description: ${product.description}\n`;
                        if (product.price) productsMessage += `   üí∞ Prix: ${product.price} ${product.currency || 'EUR'}\n`;
                        if (product.stock !== undefined) productsMessage += `   üì¶ Stock: ${product.stock}\n`;
                        if (product.category) productsMessage += `   üìÇ Cat√©gorie: ${product.category}\n`;
                        productsMessage += `\n`;
                    });
                    
                    if (data.products.length > 15) {
                        productsMessage += `... et ${data.products.length - 15} autres produits.\n\n`;
                    }
                    
                    productsMessage += `üí° **Astuce**: Tapez le nom ou la r√©f√©rence d'un produit pour le rechercher sp√©cifiquement.`;
                    
                    addMessage('nova', productsMessage);
                    
                    // Ajouter des actions rapides
                    const productActions = [
                        { label: 'üîç Rechercher produit', action: 'search_product', type: 'primary' },
                        { label: '‚ûï Nouveau produit', action: 'new_product', type: 'secondary' },
                        { label: 'üìã Cr√©er devis', action: 'start_workflow', type: 'info' }
                    ];
                    
                    addMessage('nova', 'üéØ **Actions disponibles :**', [], productActions);
                    
                } else {
                    addMessage('nova', data.message || 'üõçÔ∏è Aucun produit trouv√© dans le catalogue.');
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('nova', '‚ùå Erreur lors du chargement des produits. Veuillez r√©essayer.');
                console.error('Erreur chargement produits:', error);
            }
        }
        
        // Exporter le devis en PDF
        function exportQuoteToPDF() {
            addMessage('user', 'Exporter le devis en PDF');
            addMessage('nova', 'üìÑ **Export PDF**\n\nFonctionnalit√© en cours de d√©veloppement.\nUtilisez l\'interface classique pour exporter vos devis.');
            
            const exportActions = [
                { label: 'üíº Interface classique', action: 'open_classic', type: 'primary' }
            ];
            
            addMessage('nova', 'üéØ **Alternative :**', [], exportActions);
        }
        
        // Auto-focus sur le champ de saisie
        document.getElementById('messageInput').focus();
    </script>
</body>
</html>
