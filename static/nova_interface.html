<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA - Génération de Devis IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .logo {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .tagline {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.95em;
            opacity: 0.7;
        }

        .main-content {
            padding: 50px 40px;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .main-input {
            width: 100%;
            min-height: 140px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1.1em;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
            background: #fafbfc;
            line-height: 1.6;
        }

        .main-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .examples {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f9ff 100%);
            border-radius: 12px;
            border-left: 5px solid #3b82f6;
        }

        .examples-header {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .example-item {
            margin: 8px 0;
            padding: 8px 12px;
            font-size: 0.95em;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid transparent;
        }

        .example-item:hover {
            color: #3b82f6;
            background: white;
            border-color: #e2e8f0;
            transform: translateX(5px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .generate-button {
            flex: 2;
            padding: 18px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .details-button {
            flex: 1;
            padding: 18px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #475569;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .details-button:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .generate-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .generate-button:active {
            transform: translateY(-1px);
        }

        .generate-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .processing {
            display: none;
            text-align: center;
            padding: 40px 30px;
            background: #f8fafc;
            border-radius: 15px;
            margin-top: 25px;
            border: 2px dashed #cbd5e1;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.1em;
            color: #475569;
            font-weight: 500;
        }

        .result-panel {
            display: none;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 2px solid #bbf7d0;
            border-radius: 15px;
            padding: 30px;
            margin-top: 25px;
        }

        .result-header {
            color: #065f46;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #d1fae5;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: #374151;
        }

        .result-value {
            font-weight: 600;
            color: #059669;
        }

        .result-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .result-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
        }

        .result-btn-primary {
            background: #059669;
            color: white;
        }

        .result-btn-primary:hover {
            background: #047857;
        }

        .result-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .result-btn-secondary:hover {
            background: #e5e7eb;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.9em;
            background: #f8fafc;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.show { transform: translateX(0); }

        @media (max-width: 1366px) {
    /* Optimisation pour écrans 15" (1366x768) */
    .container {
        max-width: 95vw;
        margin: 10px auto;
    }
    
    .main-content {
        padding: 30px 25px;
    }
    
    .header {
        padding: 25px 20px;
    }
    
    .logo {
        font-size: 2.5em;
    }
}

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .details-button {
                flex: none;
            }
            
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .logo {
                font-size: 2em;
            }
            
            .result-actions {
                flex-direction: column;
            }
            
            .result-btn {
                min-width: auto;
            }
        }
        .mode-selector {
            margin-bottom: 30px;
            text-align: center;
        }

        .mode-selector h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .mode-button {
            padding: 12px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .mode-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .mode-button:hover:not(.active) {
            border-color: #667eea;
            background: #f8fafc;
        }

        .mode-description {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }        
        /* Animation de clignotement pour alerter */
        @keyframes blink-warning {
            0%, 50% { 
                background: linear-gradient(135deg, #28a745, #20c997);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }
            51%, 100% { 
                background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                transform: scale(1.02);
            }
        }

        .mode-button.has-pending {
            animation: blink-warning 2s infinite;
        }

        .pending-alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: 1px solid #ff4757;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 10px 0;
            color: white;
            font-weight: 500;
            display: none;
        }

        .pending-count {
            background: #fff;
            color: #ff4757;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                🚀 NOVA
            </div>
            <div class="tagline">Génération de Devis Intelligente</div>
            <div class="subtitle">POC IT Spirit - Intégration LLM • Salesforce • SAP</div>
        </div>

        <div class="main-content">
            <div class="section-title">
                💬 Saisie Libre en Langage Naturel
            </div>
            <div class="mode-selector">
                <h3>📋 Mode de création du devis</h3>
                <div class="mode-buttons">
                    <button class="mode-button active" id="draftMode" onclick="selectMode('draft')">
                        📝 Draft (Brouillon)
                    </button>
                    <button class="mode-button" id="normalMode" onclick="selectMode('normal')">
                        ✅ Normal (Validation)
                    </button>
                </div>
                <div class="mode-description" id="modeDescription">
                    <strong>Mode Draft :</strong> Création en brouillon dans SAP - Peut être modifié avant validation finale
                </div>
                <div class="pending-alert" id="pendingAlert">
                    ⚠️ <strong>Attention :</strong> Vous avez <span class="pending-count" id="pendingCount">0</span> devis en attente de validation !
                    <button onclick="showDraftQuotes()" style="margin-left: 10px; background: #fff; color: #ff4757; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                        📋 Voir les devis
                    </button>
                </div>
            </div>   
            <textarea 
                class="main-input" 
                id="mainInput"
                placeholder="Décrivez votre demande de devis en langage naturel...

Exemples :
• Faire un devis pour 500 unités A00002 pour le client SAFRAN
• Devis pour Edge Communications avec 100 ref A00001  
• Quote for 200 items A00003 for Airbus Industries"
            ></textarea>

            <div class="examples">
                <div class="examples-header">
                    💡 Exemples rapides :
                </div>
                <div class="example-item" onclick="fillExample('Faire un devis pour 500 unités A00002 pour le client SAFRAN')">
                    • Faire un devis pour 500 unités A00002 pour le client SAFRAN
                </div>
                <div class="example-item" onclick="fillExample('Devis pour Edge Communications avec 100 ref A00001')">
                    • Devis pour Edge Communications avec 100 ref A00001
                </div>
                <div class="example-item" onclick="fillExample('Quote for 200 items A00003 for Airbus Industries')">
                    • Quote for 200 items A00003 for Airbus Industries
                </div>
                <div class="example-item" onclick="fillExample('Créer un devis pour NOVA-DEMO-CLIENT avec 25 A00001 et 10 A00002')">
                    • Créer un devis pour NOVA-DEMO-CLIENT avec 25 A00001 et 10 A00002
                </div>
            </div>

            <div class="button-group">
                <button class="generate-button" id="generateBtn" onclick="generateQuote()">
                    🚀 Générer le Devis
                </button>
                
                <button class="details-button" onclick="showAdvancedInterface()">
                    ⚙️ Plus de détails
                </button>
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <div class="processing-text" id="processingText">🔍 Analyse de votre demande...</div>
            </div>

            <div class="result-panel" id="resultPanel">
                <div class="result-header">
                    ✅ Devis généré avec succès !
                </div>
                <div class="result-content" id="resultContent">
                    <!-- Contenu dynamique du résultat -->
                </div>
            </div>
        </div>

        <div class="footer">
            💡 <strong>POC NOVA</strong> - Démonstration d'intégration LLM avec Salesforce et SAP Business One
        </div>
    </div>

    <script>
        let currentMode = 'draft'; // Mode par défaut
        let currentTaskId = null;  // NOUVEAU : Variable globale pour le task ID
        let pollingInterval = null; // NOUVEAU : Variable globale pour l'intervalle de polling

        function selectMode(mode) {
            currentMode = mode;
            
            // Mettre à jour l'apparence des boutons
            document.getElementById('draftMode').classList.remove('active');
            document.getElementById('normalMode').classList.remove('active');
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // Mettre à jour la description
            const descriptions = {
                'draft': '<strong>Mode Draft :</strong> Création en brouillon dans SAP - Peut être modifié avant validation finale',
                'normal': '<strong>Mode Normal :</strong> Création définitive et validée dans SAP - Document contractuel'
            };
            
            document.getElementById('modeDescription').innerHTML = descriptions[mode];
            
            showNotification(`Mode ${mode === 'draft' ? 'Draft' : 'Normal'} sélectionné`, 'success');
        }
        function fillExample(text) {
            document.getElementById('mainInput').value = text;
            document.getElementById('mainInput').focus();
            showNotification('Exemple chargé !', 'success');
        }
        // Variables globales
        let pendingDraftsCount = 0;
        let pendingDrafts = [];

        // Fonction pour vérifier les devis en brouillon
        async function checkPendingDrafts() {
            try {
                const response = await fetch('/list_draft_quotes');
                const data = await response.json();
                
                if (data.success) {
                    pendingDraftsCount = data.count || 0;
                    pendingDrafts = data.draft_quotes || [];
                    
                    updatePendingUI();
                }
            } catch (error) {
                console.error('Erreur vérification devis brouillons:', error);
            }
        }

        // Mettre à jour l'interface selon les devis en attente
        function updatePendingUI() {
            const normalButton = document.getElementById('normalMode');
            const pendingAlert = document.getElementById('pendingAlert');
            const pendingCount = document.getElementById('pendingCount');
            
            if (pendingDraftsCount > 0) {
                // Faire clignoter le bouton Normal
                normalButton.classList.add('has-pending');
                normalButton.innerHTML = `✅ Normal (Validation) <span class="pending-count">${pendingDraftsCount}</span>`;
                
                // Afficher l'alerte
                pendingAlert.style.display = 'block';
                pendingCount.textContent = pendingDraftsCount;
            } else {
                // Retirer le clignotement
                normalButton.classList.remove('has-pending');
                normalButton.innerHTML = '✅ Normal (Validation)';
                
                // Masquer l'alerte
                pendingAlert.style.display = 'none';
            }
        }

        // Afficher l'interface d'édition des devis brouillons
        async function showDraftQuotes() {
            console.log("🔍 Affichage interface devis brouillons");
            
            try {
                // Récupérer les données fraîches
                const response = await fetch('/list_draft_quotes');
                const data = await response.json();
                
                if (!data.success) {
                    showNotification('Erreur lors du chargement des devis', 'error');
                    return;
                }
                
                // Créer l'interface d'édition
                createDraftQuotesModal(data.draft_quotes);
                
            } catch (error) {
                console.error('Erreur chargement devis:', error);
                showNotification('Erreur de connexion', 'error');
            }
        }

        // Créer l'interface modale d'édition
        function createDraftQuotesModal(quotes) {
            // Créer le modal
            const modal = document.createElement('div');
            modal.id = 'draftQuotesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    width: 100%;
                    max-width: 1200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <!-- Header -->
                    <div style="
                        padding: 20px;
                        border-bottom: 1px solid #e2e8f0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: #f8fafc;
                        border-radius: 12px 12px 0 0;
                    ">
                        <h2 style="margin: 0; color: #1e293b; font-size: 1.5rem;">
                            📋 Gestion des Devis Brouillons (${quotes.length})
                        </h2>
                        <button onclick="closeDraftModal()" style="
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            cursor: pointer;
                            color: #64748b;
                            padding: 5px;
                        ">✕</button>
                    </div>
                    
                    <!-- Content -->
                    <div style="padding: 20px;">
                        ${quotes.length === 0 ? 
                            '<p style="text-align: center; color: #64748b; font-size: 1.1rem;">Aucun devis en brouillon</p>' :
                            quotes.map(quote => createQuoteCard(quote)).join('')
                        }
                    </div>
                    
                    <!-- Footer -->
                    <div style="
                        padding: 20px;
                        border-top: 1px solid #e2e8f0;
                        background: #f8fafc;
                        border-radius: 0 0 12px 12px;
                        text-align: center;
                    ">
                        <button onclick="closeDraftModal()" style="
                            background: #64748b;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 1rem;
                        ">Fermer</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Créer une carte pour chaque devis
        function createQuoteCard(quote) {
            return `
                <div class="quote-card" style="
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 16px;
                    background: #fafafa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; color: #1e293b;">
                                🧾 Devis #${quote.doc_num} 
                                <span style="font-size: 0.8rem; color: #64748b;">(ID: ${quote.doc_entry})</span>
                            </h3>
                            <p style="margin: 0; color: #475569;">
                                👤 <strong>${quote.card_name}</strong> (${quote.card_code})
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #059669;">
                                ${parseFloat(quote.doc_total).toLocaleString('fr-FR')} ${quote.currency}
                            </div>
                            <div style="font-size: 0.9rem; color: #64748b;">
                                📅 ${new Date(quote.doc_date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="editQuote(${quote.doc_entry})" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">✏️ Éditer</button>
                        
                        <button onclick="validateQuote(${quote.doc_entry})" style="
                            background: #059669;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">✅ Valider</button>
                        
                        <button onclick="duplicateQuote(${quote.doc_entry})" style="
                            background: #7c3aed;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">📄 Dupliquer</button>
                        
                        <button onclick="deleteQuote(${quote.doc_entry})" style="
                            background: #dc2626;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">🗑️ Supprimer</button>
                    </div>
                    
                    ${quote.comments ? `
                        <div style="margin-top: 8px; padding: 8px; background: #fef3cd; border-radius: 4px; font-size: 0.9rem;">
                            💬 ${quote.comments}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Fermer le modal
        function closeDraftModal() {
            const modal = document.getElementById('draftQuotesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Actions sur les devis
        async function validateQuote(docEntry) {
            if (!confirm('Êtes-vous sûr de vouloir valider ce devis en définitif ?')) return;
            
            try {
                const response = await fetch('/validate_quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_entry: docEntry })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Devis validé avec succès !', 'success');
                    closeDraftModal();
                    checkPendingDrafts(); // Rafraîchir le compteur
                } else {
                    showNotification('Erreur lors de la validation', 'error');
                }
            } catch (error) {
                showNotification('Erreur de connexion', 'error');
            }
        }

        async function editQuote(docEntry) {
            showNotification('Fonction d\'édition en développement...', 'info');
            // TODO: Implémenter l'édition complète
        }

        async function duplicateQuote(docEntry) {
            showNotification('Fonction de duplication en développement...', 'info');
            // TODO: Implémenter la duplication
        }

        async function deleteQuote(docEntry) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce devis ?')) return;
            showNotification('Fonction de suppression en développement...', 'info');
            // TODO: Implémenter la suppression
        }

        // Vérifier au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            checkPendingDrafts();
        });

        async function generateQuote() {
            const isDraftMode = document.getElementById('draftMode').checked;
            console.log("🔄 Début generateQuote()");
            
            const generateBtn = document.getElementById('generateBtn');
            const promptInput = document.getElementById('mainInput');
            const prompt = promptInput?.value?.trim();
            // Alerte si on essaie de créer un draft alors qu'il y en a déjà
            if (isDraftMode && pendingDraftsCount > 0) {
                const proceed = confirm(`⚠️ Attention !\n\nVous avez déjà ${pendingDraftsCount} devis en brouillon en attente de validation.\n\nVoulez-vous vraiment créer un nouveau brouillon ?`);
                if (!proceed) {
                    return;
                }
            }
            if (!prompt) {
                showError('Veuillez saisir une demande de devis');
                return;
            }
            
            // Verrouillage interface
            const processing = document.getElementById('processing');
            const resultPanel = document.getElementById('resultPanel');
            
            generateBtn.disabled = true;
            processing.style.display = 'block';
            resultPanel.style.display = 'none';
            
            // Initialiser l'affichage de progression détaillée
            const progressContent = processing.querySelector('.progress-content') || (() => {
                const content = document.createElement('div');
                content.className = 'progress-content';
                content.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 10px;
                    border-left: 4px solid #667eea;
                `;
                processing.appendChild(content);
                return content;
            })();

            progressContent.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div class="spinner" style="
                        width: 20px; height: 20px; 
                        border: 2px solid #f3f3f3; 
                        border-top: 2px solid #667eea; 
                        border-radius: 50%; 
                        animation: spin 1s linear infinite;
                        margin-right: 10px;
                    "></div>
                    <span id="current-step">Initialisation...</span>
                </div>
                <div style="background: #f1f5f9; border-radius: 4px; height: 6px; overflow: hidden;">
                    <div id="progress-bar" style="
                        height: 100%; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        width: 0%; 
                        transition: width 0.3s ease;
                    "></div>
                </div>
                <div id="progress-details" style="
                    font-size: 0.85em; 
                    color: #64748b; 
                    margin-top: 8px;
                ">Préparation de votre devis...</div>
            `;

            // Ajouter styles CSS si pas présents
            if (!document.querySelector('#progress-styles')) {
                const styles = document.createElement('style');
                styles.id = 'progress-styles';
                styles.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            try {
                console.log("🚀 Appel API:", prompt);
                
                const response = await fetch('/progress/generate_quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        draft_mode: currentMode === 'draft'
                    })
                });
                
                console.log("📡 Réponse reçue, status:", response.status);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log("✅ JSON parsé:", result);

                // Gestion de la réponse avec task_id
                if (result.task_id) {
                    currentTaskId = result.task_id;
                    console.log("🔄 Démarrage polling pour task:", currentTaskId);
                    startProgressPolling(currentTaskId);
                } else {
                    // Fallback pour l'ancien système
                    generateBtn.disabled = false;
                    processing.style.display = 'none';
                    
                    if (result.status === 'success') {
                        showQuoteResult(result);
                    } else {
                        showError(result.message || 'Erreur de traitement');
                    }
                }
                
            } catch (error) {
                console.error("❌ Erreur fatale:", error);
                generateBtn.disabled = false;
                processing.style.display = 'none';
                showError(`Communication échouée: ${error.message}`, result);
            }
        }
        async function startProgressPolling(taskId) {
            let attempts = 0;
            const maxAttempts = 120; // 2 minutes max
            
            pollingInterval = setInterval(async () => {
                attempts++;
        
            try {
                const response = await fetch(`/progress/quote_status/${taskId}?detailed=true`);
                if (!response.ok) {
                    throw new Error(`Status ${response.status}`);
                }
                
                const progress = await response.json();
                updateProgressDisplay(progress);
                
                // Vérifier si terminé
                if (progress.status === 'completed') {
                    clearInterval(pollingInterval);
                    showQuoteResult(progress.result || progress);
                    resetProgressDisplay();
                } else if (progress.status === 'failed') {
                    clearInterval(pollingInterval);
                    
                    // Transmettre l'objet complet d'erreur pour détecter les types spéciaux
                    const errorData = progress.result || progress.error || 'Erreur de génération';
                    showError(errorData);
                    resetProgressDisplay();
                } else if (progress.status === 'warning') {
                    // 🔧 NOUVEAU : Gérer les avertissements (doublons détectés)
                    clearInterval(pollingInterval);
                    
                    // Transmettre l'objet complet pour détecter les doublons
                    const warningData = progress.result || progress;
                    showError(warningData);
                    resetProgressDisplay();
                }
                
            } catch (error) {
                console.error("❌ Erreur polling:", error);
                if (attempts >= maxAttempts) {
                    clearInterval(pollingInterval);
                    showError('Timeout - génération trop longue');
                    resetProgressDisplay();
                }
            }
        }, 1000); // Polling toutes les secondes
    }

        function updateProgressDisplay(progress) {
            const currentStepEl = document.getElementById('current-step');
            const progressBarEl = document.getElementById('progress-bar');
            const progressDetailsEl = document.getElementById('progress-details');
            
            if (currentStepEl && progress.current_step_title) {
                currentStepEl.textContent = progress.current_step_title;
            }
            
            if (progressBarEl && progress.overall_progress !== undefined) {
                progressBarEl.style.width = `${progress.overall_progress}%`;
            }
            
            if (progressDetailsEl) {
                let details = `Étape ${progress.completed_steps || 0}/${progress.total_steps || 8}`;
                if (progress.phases) {
                    // Trouver l'étape actuelle dans les phases
                    for (const phase of Object.values(progress.phases)) {
                        const currentStep = phase.steps.find(s => s.status === 'running');
                        if (currentStep) {
                            details += ` - ${currentStep.message}`;
                            break;
                        }
                    }
                }
                progressDetailsEl.textContent = details;
            }
        }

        function resetProgressDisplay() {
            const generateBtn = document.getElementById('generateBtn');
            const processing = document.getElementById('processing');
            
            if (generateBtn) generateBtn.disabled = false;
            if (processing) processing.style.display = 'none';
            
            currentTaskId = null;
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }       

    function showQuoteResult(result) {
            // ✅ DIAGNOSTIC COMPLET
            console.log("=== 🔍 DIAGNOSTIC COMPLET DES DONNEES ===");
            console.log("📋 Structure complète reçue:");
            console.log(JSON.stringify(result, null, 2));
            
            // Vérifier si le devis nécessite confirmation avant l'affichage
            if (result.quote_data?.require_confirmation === true) {
                console.log("⚠️ Confirmation requise avant création/modification du devis");
                showQuoteConfirmation(result);
                return; // Arrêter l'exécution normale
            }
            
            console.log("\n🏢 ANALYSE CLIENT:");
            console.log("- result.client:", result.client);
            console.log("- result.client?.name:", result.client?.name);
            console.log("- result.client_name:", result.client_name);
            console.log("- result.client_info:", result.client_info);
            
            console.log("\n📦 ANALYSE PRODUITS:");
            console.log("- result.products:", result.products);
            console.log("- result.quote_data?.products:", result.quote_data?.products);
            console.log("- Nombre de produits:", result.products?.length || result.quote_data?.products?.length || 0);
            
            console.log("\n💰 ANALYSE MONTANTS:");
            console.log("- result.total_amount:", result.total_amount);
            console.log("- result.currency:", result.currency);
            console.log("\n🔑 ANALYSE CODE CLIENT:");
            console.log("- result.system_references:", result.system_references);
            if (result.system_references) {
                console.log("- result.system_references.sap_client_card_code:", result.system_references.sap_client_card_code);
            }
            console.log("- result.client:", result.client);
            if (result.client) {
                console.log("- result.client.CardCode:", result.client.CardCode);
                console.log("- result.client.sap_card_code:", result.client.sap_card_code);
                console.log("- result.client.card_code:", result.client.card_code);
            }
            console.log("- result.sap_card_code:", result.sap_card_code);
            console.log("- result.CardCode:", result.CardCode);
            // Masquer le processing et afficher le résultat
            document.getElementById('processing').style.display = 'none';
            document.getElementById('resultPanel').style.display = 'block';
            document.getElementById('generateBtn').disabled = false;
            
            // ✅ LOGIQUE D'AFFICHAGE CLIENT ROBUSTE
            let clientName = 'Client non identifié';
            
            // Essayer différentes structures possibles
            if (result.client?.name) {
                clientName = result.client.name;
                console.log("✅ Client trouvé via result.client.name:", clientName);
            } else if (result.client_name) {
                clientName = result.client_name;
                console.log("✅ Client trouvé via result.client_name:", clientName);
            } else if (result.client_info?.name) {
                clientName = result.client_info.name;
                console.log("✅ Client trouvé via result.client_info.name:", clientName);
            } else if (typeof result.client === 'string') {
                clientName = result.client;
                console.log("✅ Client trouvé comme string directe:", clientName);
            } else {
                console.log("❌ PROBLÈME: Aucune structure client trouvée!");
                console.log("📋 Structures client disponibles:");
                Object.keys(result).filter(key => key.toLowerCase().includes('client')).forEach(key => {
                    console.log(`   - ${key}:`, result[key]);
                });
            }
            
            // ✅ LOGIQUE D'AFFICHAGE PRODUITS ROBUSTE  
            let productsDisplay = '';
            let productsCount = 0;
            let productsArray = [];
            
            // Rechercher les produits dans différentes structures possibles
            if (result.quote_data?.products && Array.isArray(result.quote_data.products) && result.quote_data.products.length > 0) {
                productsArray = result.quote_data.products;
                console.log("✅ Produits trouvés via result.quote_data.products");
            } else if (result.products && Array.isArray(result.products) && result.products.length > 0) {
                productsArray = result.products;
                console.log("✅ Produits trouvés via result.products");
            }
            
            // Traitement des produits si présents
            if (productsArray.length > 0) {
                productsCount = productsArray.length;
                const displayedProducts = productsArray.slice(0, 3); // Montrer max 3
                
                productsDisplay = displayedProducts.map(product => {
                    const code = product.code || product.id || product.item_code || 'N/A';
                    const name = product.name || product.item_name || 'Produit';
                    const quantity = product.quantity || 1;
                    const price = product.unit_price || product.price || 0;
                    
                    return `${name} (${quantity}x à ${price.toFixed(2)}€)`;
                }).join(', ');
                
                if (productsArray.length > 3) {
                    productsDisplay += ` et ${productsArray.length - 3} autre(s)`;
                }
            } else {
                productsDisplay = 'Aucun produit détaillé';
                console.log("⚠️ Pas de produits trouvés dans aucune structure");
            }
            
            // ✅ MONTANT TOTAL ROBUSTE
            const totalAmount = parseFloat(result.quote_data?.total_amount || result.total_amount) || 0;
            const currency = result.currency || 'EUR';
            const formattedAmount = totalAmount.toLocaleString('fr-FR', {
                style: 'currency',
                currency: currency
            });
            
            // ✅ AFFICHAGE AVEC DIAGNOSTICS VISUELS
            const resultContent = `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="color: #0369a1; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">✅</span>
                        Devis généré avec succès
                    </h3>
                    
                    <!-- DIAGNOSTIC CLIENT VISIBLE -->
                    <div class="result-item" style="background: ${clientName === 'Client non identifié' ? '#fef3c7' : '#f0fdf4'}; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <span class="result-label">🏢 Client</span>
                        <span class="result-value" style="font-weight: bold; color: ${clientName === 'Client non identifié' ? '#d97706' : '#059669'};">
                            ${clientName}
                        </span>
                        ${clientName === 'Client non identifié' ? '<div style="font-size: 0.8em; color: #d97706; margin-top: 5px;">⚠️ Nom client non récupéré - voir console pour diagnostic</div>' : ''}
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">📋 Devis N°</span>
                        <span class="result-value">${result.quote_id || 'NOVA-' + Date.now().toString().slice(-6)}</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">📦 Produits (${productsCount})</span>
                        <span class="result-value">${productsDisplay}</span>
                    </div>
                    
                    <!-- Tableau détaillé des produits -->
                    ${productsArray.length > 0 ? `
                    <div style="margin-top: 15px; background: #f8fafc; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f1f5f9; text-align: left;">
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Produit</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Description</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center;">Qté</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right;">Prix unit.</th>
                                    <th style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsArray.map((product, index) => `
                                <tr style="${index % 2 === 0 ? 'background: #ffffff;' : 'background: #f8fafc;'}">
                                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                                        <div style="font-weight: 600;">${product.name || 'Sans nom'}</div>
                                        <div style="font-size: 0.8em; color: #64748b;">${product.code || product.id || 'N/A'}</div>
                                    </td>
                                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0;">${product.description || '-'}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: center; font-weight: 600;">${product.quantity || 1}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; font-family: monospace;">${(product.unit_price || 0).toFixed(2)} €</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: right; font-weight: 700; color: #0369a1; font-family: monospace;">${((product.unit_price || 0) * (product.quantity || 1)).toFixed(2)} €</td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                    
                    <div class="result-item">
                        <span class="result-label">💰 Montant Total</span>
                        <span class="result-value" style="font-size: 1.2em; font-weight: bold; color: #059669;">
                            ${formattedAmount}
                        </span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">📅 Date</span>
                        <span class="result-value">${result.date || new Date().toLocaleDateString('fr-FR')}</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">📊 Statut</span>
                        <span class="result-value" style="color: #059669; font-weight: bold;">
                            ${result.quote_status || 'Créé'} ${result.draft_mode ? '(Brouillon)' : '(Validé)'}
                        </span>
                    </div>
                </div>
                
                <!-- Actions disponibles -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button onclick="generatePDFFromButton(this)" data-result='${JSON.stringify(result).replace(/'/g, "&apos;")}' 
                        style="background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        📄 Générer PDF
                    </button>
                    <button onclick="newQuote()" style="background: #f3f4f6; color: #374151; padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">
                        🔄 Nouveau Devis
                    </button>
                </div>
                
                <!-- Diagnostic technique (masquable) -->
                <details style="margin-top: 20px; font-size: 0.9em;">
                    <summary style="cursor: pointer; color: #6b7280;">🔧 Informations techniques</summary>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-top: 10px; font-family: monospace; white-space: pre-wrap;">Mode: ${result.draft_mode ? 'Brouillon' : 'Production'}
        SAP DocNum: ${result.sap_doc_num || 'N/A'}
        Salesforce ID: ${result.salesforce_quote_id || 'N/A'}
        Données client brutes: ${JSON.stringify(result.client || {}, null, 2)}</div>
                </details>
            `;
            
            document.getElementById('resultContent').innerHTML = resultContent;
            
            // Notification de fin avec résumé
            showNotification(`✅ Devis créé pour ${clientName} - ${formattedAmount}`, 'success');
            
            console.log("=== 🎯 RÉSUMÉ DIAGNOSTIC ===");
            console.log(`Client affiché: "${clientName}"`);
            console.log(`Produits: ${productsCount}`);
            console.log(`Montant: ${formattedAmount}`);
            console.log("=== FIN DIAGNOSTIC ===");
        }
        
        // Fonction de confirmation utilisateur pour les devis
        function showQuoteConfirmation(result) {
            console.log("Affichage de la confirmation pour devis:", result);
            
            // Masquer le traitement en cours
            document.getElementById('processing').style.display = 'none';
            
            // Récupérer les informations du devis
            const quoteData = result.quote_data || {};
            const clientName = quoteData.client || 'Client non identifié';
            const productCount = quoteData.products?.length || 0;
            const totalAmount = parseFloat(quoteData.total_amount || 0);
            const formattedAmount = totalAmount.toLocaleString('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            });
            
            // Créer l'overlay de fond semi-transparent
            const overlay = document.createElement('div');
            overlay.id = 'quote-confirmation-overlay';
            overlay.style = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 1999;
                backdrop-filter: blur(3px);
                display: flex;
                justify-content: center;
                align-items: center;
            `;
            document.body.appendChild(overlay);
            
            // Créer la boîte de dialogue de confirmation
            const confirmDialog = document.createElement('div');
            confirmDialog.id = 'quote-confirmation-dialog';
            confirmDialog.style = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                width: 500px;
                max-width: 95%;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                text-align: left;
            `;
            
            // Produits résumés pour le modal
            let productsDisplay = '';
            if (quoteData.products && quoteData.products.length > 0) {
                const products = quoteData.products;
                productsDisplay = products.slice(0, 2).map(product => 
                    `${product.name || product.id || 'Produit'} (${product.quantity || 1}x)`
                ).join(', ');
                
                if (products.length > 2) {
                    productsDisplay += ` et ${products.length - 2} autre(s)`;
                }
            } else {
                productsDisplay = 'Aucun produit détaillé';
            }
            
            // Contenu de la boîte de dialogue
            confirmDialog.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #0369a1; font-size: 1.5em;">Confirmation du devis</h3>
                    <p style="margin: 10px 0 0; color: #6b7280;">${quoteData.confirmation_message || 'Veuillez confirmer la création de ce devis'}</p>
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: bold;">🏢 Client:</span> ${clientName}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: bold;">📦 Produits:</span> ${productsDisplay}
                    </div>
                    <div style="font-weight: bold; color: #0369a1; font-size: 1.1em;">
                        <span>💰 Total:</span> ${formattedAmount}
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="confirm-quote-btn" style="
                        background: #0369a1;
                        color: white;
                        border: none;
                        padding: 12px 25px;
                        border-radius: 6px;
                        font-weight: bold;
                        cursor: pointer;
                    ">✅ Confirmer</button>
                    
                    <button id="modify-quote-btn" style="
                        background: #f3f4f6;
                        color: #1f2937;
                        border: 1px solid #d1d5db;
                        padding: 12px 25px;
                        border-radius: 6px;
                        font-weight: bold;
                        cursor: pointer;
                    ">✏️ Modifier</button>
                    
                    <button id="cancel-quote-btn" style="
                        background: #ef4444;
                        color: white;
                        border: none;
                        padding: 12px 25px;
                        border-radius: 6px;
                        font-weight: bold;
                        cursor: pointer;
                    ">❌ Annuler</button>
                </div>
            `;
            
            overlay.appendChild(confirmDialog);
            
            // Gérer les événements des boutons
            document.getElementById('confirm-quote-btn').addEventListener('click', function() {
                confirmQuoteAction(result, 'confirm');
            });
            
            document.getElementById('modify-quote-btn').addEventListener('click', function() {
                confirmQuoteAction(result, 'modify');
            });
            
            document.getElementById('cancel-quote-btn').addEventListener('click', function() {
                closeQuoteConfirmation();
            });
        }
        
        // Fermer la boîte de dialogue de confirmation
        function closeQuoteConfirmation() {
            const overlay = document.getElementById('quote-confirmation-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
            
            // Réactiver le bouton de génération
            document.getElementById('generateBtn').disabled = false;
        }
        
        // Traiter l'action de confirmation du devis
        async function confirmQuoteAction(result, action) {
            console.log(`Action de confirmation: ${action}`);
            
            try {
                // Afficher le traitement en cours
                document.getElementById('processing').style.display = 'block';
                
                // Fermer la boîte de dialogue
                closeQuoteConfirmation();
                
                // Préparer les données à envoyer
                const confirmData = {
                    task_id: result.task_id,
                    action: action,
                    confirmed: action === 'confirm'
                };
                
                // Envoyer la confirmation au backend
                const response = await fetch('/api/quote/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(confirmData)
                });
                
                const confirmResult = await response.json();
                
                if (action === 'confirm') {
                    // Afficher le résultat final si confirmation
                    showQuoteResult(confirmResult);
                } else if (action === 'modify') {
                    // Revenir à l'état initial pour modification
                    document.getElementById('processing').style.display = 'none';
                    document.getElementById('generateBtn').disabled = false;
                    showNotification('✏️ Modifiez votre demande et régénérez le devis', 'info');
                } else {
                    // Annulation
                    document.getElementById('processing').style.display = 'none';
                    document.getElementById('generateBtn').disabled = false;
                    showNotification('❌ Génération de devis annulée', 'info');
                }
                
            } catch (error) {
                console.error("Erreur lors de la confirmation:", error);
                document.getElementById('processing').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
                showError(`Erreur de confirmation: ${error.message}`);
            }
        }
        
        // 1. Remplacer showQuotePreview par cette version avec VRAIES DONNÉES
        function showQuotePreview(result) {
            console.log("showQuotePreview appelée avec:", result);
            
            // Supprimer l'ancien aperçu s'il existe
            const oldPreview = document.getElementById('quote-preview');
            if (oldPreview) oldPreview.remove();
            
            const oldBtn = document.getElementById('pdf-export-btn');
            if (oldBtn) oldBtn.remove();

            // Créer l'overlay de fond
            const overlay = document.createElement('div');
            overlay.id = 'pdf-overlay';
            overlay.style = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 1999;
                backdrop-filter: blur(3px);
            `;
            overlay.onclick = closePDFPreview;
            document.body.appendChild(overlay);

            const previewContainer = document.createElement('div');
            previewContainer.id = 'quote-preview';
            previewContainer.style = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 40px;
                width: 1000px;
                max-width: 95vw;
                max-height: 95vh;
                overflow-y: auto;
                border-radius: 12px;
                font-family: 'Segoe UI', Arial, sans-serif;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 2000;
                font-size: 14px;
                line-height: 1.5;
            `;

            // VRAIES DONNÉES extraites de votre structure JSON
            const clientName = result.client?.name || 'Client non défini';
            const clientCode = result.client?.account_number || 'N/A';
            const clientSalesforceId = result.client?.salesforce_id || 'N/A';
            const quoteNumber = result.quote_id || 'NOVA-' + Date.now().toString().slice(-6);
            const totalAmount = parseFloat(result.total_amount) || 0;
            const currency = result.currency || 'EUR';
            const quoteDate = result.date || new Date().toLocaleDateString('fr-FR');

            // Tableau des produits avec VRAIES DONNÉES
            let productsList = '';
            let stockWarning = '';
            
            if (Array.isArray(result.products) && result.products.length > 0) {
                let hasOutOfStock = false;
                
                productsList = result.products.map((p, index) => {
                    const quantity = p.quantity || 1;
                    const productName = p.name || p.code || 'Produit sans nom';
                    const unitPrice = parseFloat(p.unit_price) || 0;
                    const lineTotal = parseFloat(p.line_total) || (quantity * unitPrice);
                    
                    // Simulation vérification stock (vous pouvez ajouter un champ stock dans votre API)
                    const inStock = quantity <= 1000; // Exemple : considérer en stock si qty <= 1000
                    if (!inStock) hasOutOfStock = true;
                    
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb; ${index % 2 === 0 ? 'background: #f9fafb;' : ''}">
                            <td style="padding: 12px 8px; font-weight: 600; color: #374151;">${p.code || 'N/A'}</td>
                            <td style="padding: 12px 8px; color: #374151;">${productName}</td>
                            <td style="padding: 12px 8px; text-align: center; font-weight: 600;">${quantity}</td>
                            <td style="padding: 12px 8px; text-align: right; font-family: monospace;">${unitPrice.toFixed(2)} €</td>
                            <td style="padding: 12px 8px; text-align: right; font-weight: 700; color: #059669; font-family: monospace;">${lineTotal.toFixed(2)} €</td>
                        </tr>
                    `;
                }).join('');
                
                // Message stock selon disponibilité
                if (result.all_products_available === true) {
                    stockWarning = `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e; margin-bottom: 20px;">
                            <p style="margin: 0; color: #15803d; font-weight: 600;">
                                ✅ <strong>Produits en stock</strong> - Délai de livraison : 5-7 jours ouvrés
                            </p>
                        </div>
                    `;
                } else {
                    stockWarning = `
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
                            <p style="margin: 0; color: #92400e; font-weight: 600;">
                                ⚠️ <strong>Produits en rupture</strong> - Délai de livraison : 3 semaines sous réserve de disponibilités fabricant
                            </p>
                        </div>
                    `;
                }
            } else {
                productsList = '<tr><td colspan="5" style="padding: 30px; text-align: center; color: #9ca3af; font-style: italic;">Aucun produit défini</td></tr>';
            }

            // Calculer les totaux
            const totalHT = totalAmount;
            const totalTVA = totalHT * 0.2;
            const totalTTC = totalHT + totalTVA;

            previewContainer.innerHTML = `
                <!-- En-tête du devis -->
                <div style="text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #667eea;">
                    <h1 style="margin: 0; color: #1f2937; font-size: 2.2em; font-weight: 700;">
                        🧾 DEVIS COMMERCIAL
                    </h1>
                    <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 1.1em; font-weight: 500;">
                        Document contractuel - Validité 30 jours
                    </p>
                </div>
                
                <!-- Informations principales en 2 colonnes -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
                    <div style="background: #f8fafc; padding: 25px; border-radius: 10px; border-left: 5px solid #3b82f6;">
                        <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            📋 Informations Devis
                        </h3>
                        <div style="space-y: 10px;">
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">N° Devis :</span>
                                <span style="font-weight: 700; color: #1f2937;">${quoteNumber}</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">Date d'émission :</span>
                                <span style="font-weight: 600; color: #1f2937;">${quoteDate}</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">Validité :</span>
                                <span style="font-weight: 600; color: #dc2626;">30 jours</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">Statut :</span>
                                <span style="font-weight: 600; color: #059669;">✅ ${result.quote_status || 'Créé'}</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 25px; border-radius: 10px; border-left: 5px solid #22c55e;">
                        <h3 style="color: #1f2937; margin: 0 0 20px 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            🏢 Informations Client
                        </h3>
                        <div style="space-y: 10px;">
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">Nom :</span>
                                <span style="font-weight: 700; color: #1f2937;">${clientName}</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">Code client :</span>
                                <span style="font-weight: 600; color: #1f2937;">${clientCode}</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">ID Salesforce :</span>
                                <span style="font-weight: 500; color: #1f2937;">${result.client?.salesforce_id || 'N/A'}</span>
                            </p>
                            <p style="margin: 8px 0; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280; font-weight: 500;">SAP DocNum :</span>
                                <span style="font-weight: 500; color: #1f2937;">${result.sap_doc_num || 'N/A'}</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Message stock -->
                ${stockWarning}

                <!-- Tableau des produits -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #1f2937; margin-bottom: 20px; font-size: 1.4em; display: flex; align-items: center; gap: 10px;">
                        📦 Détail des Produits
                    </h3>
                    <div style="overflow-x: auto; border-radius: 10px; border: 1px solid #e5e7eb;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 15px 12px; text-align: left; font-weight: 700; font-size: 1em;">Code Produit</th>
                                    <th style="padding: 15px 12px; text-align: left; font-weight: 700; font-size: 1em;">Désignation</th>
                                    <th style="padding: 15px 12px; text-align: center; font-weight: 700; font-size: 1em;">Quantité</th>
                                    <th style="padding: 15px 12px; text-align: right; font-weight: 700; font-size: 1em;">Prix Unit. HT</th>
                                    <th style="padding: 15px 12px; text-align: right; font-weight: 700; font-size: 1em;">Total HT</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsList}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Récapitulatif financier -->
                <div style="margin-bottom: 40px;">
                    <div style="float: right; background: #f8fafc; padding: 25px; border-radius: 12px; min-width: 350px; border: 2px solid #cbd5e1;">
                        <h4 style="color: #1f2937; margin: 0 0 20px 0; font-size: 1.2em; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
                            💰 Récapitulatif Financier
                        </h4>
                        <div style="space-y: 8px;">
                            <p style="margin: 10px 0; display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #374151; font-weight: 600;">Total HT :</span>
                                <span style="font-weight: 700; color: #1f2937; font-family: monospace; font-size: 1.1em;">${totalHT.toFixed(2)} ${currency}</span>
                            </p>
                            <p style="margin: 10px 0; display: flex; justify-content: space-between; padding: 8px 0; border-top: 1px solid #e5e7eb;">
                                <span style="color: #374151; font-weight: 600;">TVA (20%) :</span>
                                <span style="font-weight: 600; color: #6b7280; font-family: monospace;">${totalTVA.toFixed(2)} EUR</span>
                            </p>
                            <p style="margin: 15px 0 0 0; display: flex; justify-content: space-between; padding: 12px; border-top: 3px solid #059669; background: #f0fdf4; border-radius: 6px;">
                                <span style="color: #059669; font-weight: 700; font-size: 1.1em;">TOTAL TTC :</span>
                                <span style="font-weight: 900; color: #059669; font-family: monospace; font-size: 1.3em;">${totalTTC.toFixed(2)} EUR</span>
                            </p>
                        </div>
                    </div>
                    <div style="clear: both;"></div>
                </div>

                <!-- Conditions commerciales -->
                <div style="background: #fffbeb; padding: 25px; border-radius: 10px; border-left: 5px solid #f59e0b; margin-top: 30px;">
                    <h4 style="color: #92400e; margin: 0 0 15px 0; font-size: 1.2em; display: flex; align-items: center; gap: 8px;">
                        📋 Conditions Commerciales
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; color: #78350f; font-size: 0.95em; line-height: 1.6;">
                        <ul style="margin: 0; padding-left: 20px;">
                            <li style="margin: 6px 0;"><strong>Validité :</strong> 30 jours à compter de la date d'émission</li>
                            <li style="margin: 6px 0;"><strong>Délai de livraison :</strong> ${result.all_products_available ? '5-7 jours ouvrés après confirmation' : '3 semaines sous réserve de disponibilités fabricant'}</li>
                        </ul>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li style="margin: 6px 0;"><strong>Conditions de paiement :</strong> 30 jours net</li>
                            <li style="margin: 6px 0;"><strong>Prix :</strong> Exprimés en euros hors taxes</li>
                        </ul>
                    </div>
                </div>

                <!-- Pied de page -->
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; color: #6b7280; font-size: 0.9em;">
                    <p style="margin: 0; font-style: italic;">
                        <em>Devis généré automatiquement par NOVA Middleware - ${new Date().toLocaleString('fr-FR')}</em>
                    </p>
                </div>

                <!-- Boutons d'action -->
                <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                    <button onclick="closePDFPreview()" style="
                        background: #f1f5f9;
                        border: 1px solid #e2e8f0;
                        color: #64748b;
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1.2em;
                        width: 35px;
                        height: 35px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">✕</button>
                </div>
            `;

            document.body.appendChild(previewContainer);

            // Bouton export PDF
            const exportBtn = document.createElement('button');
            exportBtn.id = 'pdf-export-btn';
            exportBtn.innerHTML = '📄 Télécharger PDF';
            exportBtn.style = `
                position: fixed;
                bottom: 40px;
                right: 40px;
                padding: 15px 30px;
                background: #1d4ed8;
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 10px 25px rgba(29, 78, 216, 0.3);
                z-index: 2001;
                transition: all 0.3s ease;
            `;
            
            exportBtn.addEventListener('click', function() {
                console.log("Bouton PDF cliqué !");
                setTimeout(() => {
                    generatePDFWorking(result);
                }, 100);
            });
            
            document.body.appendChild(exportBtn);
            
            console.log("Aperçu PDF créé avec vraies données");
        }

        // Fonction pour fermer l'aperçu (mise à jour)
        function closePDFPreview() {
            const overlay = document.getElementById('pdf-overlay');
            const preview = document.getElementById('quote-preview');
            const btn = document.getElementById('pdf-export-btn');
            
            if (overlay) overlay.remove();
            if (preview) preview.remove();
            if (btn) btn.remove();
        }

        // 2. Nouvelle fonction PDF qui FONCTIONNE vraiment
        function generatePDFWorking(result) {
            console.log("=== AFFICHAGE PDF INLINE (SANS POPUP) ===");
            
            // Fermer l'aperçu actuel
            closePDFPreview();
            
            // Extraire les données
            const clientName = result.client?.name || 'Client Demo';
            const quoteNumber = result.quote_id || 'NOVA-DEMO';
            const totalAmount = parseFloat(result.total_amount) || 12000;
            const currency = result.currency || 'EUR';
            const quoteDate = result.date || new Date().toLocaleDateString('fr-FR');
            
            // Construire le tableau des produits
            let productsHTML = '';
            if (result.products && result.products.length > 0) {
                productsHTML = result.products.map(p => `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #333;">${p.code || 'N/A'}</td>
                        <td style="padding: 8px; border: 1px solid #333;">${p.name || 'Produit'}</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: center;">${p.quantity || 1}</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: right;">${parseFloat(p.unit_price || 0).toFixed(2)} €</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: right; font-weight: bold;">${parseFloat(p.line_total || 0).toFixed(2)} €</td>
                    </tr>
                `).join('');
            } else {
                productsHTML = `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #333;">A00001</td>
                        <td style="padding: 8px; border: 1px solid #333;">Produit de démonstration</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: center;">100</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: right;">120,00 €</td>
                        <td style="padding: 8px; border: 1px solid #333; text-align: right; font-weight: bold;">${totalAmount.toFixed(2)} €</td>
                    </tr>
                `;
            }
            
            // Créer l'overlay PDF complet
            const pdfOverlay = document.createElement('div');
            pdfOverlay.id = 'pdf-full-overlay';
            pdfOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                overflow-y: auto;
                font-family: Arial, sans-serif;
            `;
            
            pdfOverlay.innerHTML = `
                <!-- Barre de contrôle fixe -->
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #667eea;
                    color: white;
                    padding: 15px 20px;
                    z-index: 10000;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                ">
                    <h3 style="margin: 0; font-size: 18px;">📄 Aperçu Devis ${quoteNumber}</h3>
                    <div>
                        <button onclick="window.print()" style="
                            background: white;
                            color: #667eea;
                            border: none;
                            padding: 10px 20px;
                            margin-right: 10px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                        ">🖨️ Imprimer PDF</button>
                        <button onclick="closePDFFullscreen()" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 1px solid white;
                            padding: 10px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                        ">✕ Fermer</button>
                    </div>
                </div>
                
                <!-- Contenu PDF -->
                        <div id="printable-content" style="
                            margin-top: 80px;
                            max-width: 800px;
                            margin-left: auto;
                            margin-right: auto;
                            padding: 40px;
                            background: white;
                            box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            min-height: calc(100vh - 120px);
                        ">
                            
                            <style>
                                @media print {
                                    /* Forcer portrait et une seule page */
                                    @page {
                                        size: A4 portrait;
                                        margin: 15mm;
                                    }
                                    
                                    /* Masquer TOUT ce qui n'est pas le contenu à imprimer */
                                    body > *:not(#pdf-full-overlay) {
                                        display: none !important;
                                    }
                                    
                                    /* Masquer les éléments de contrôle dans l'overlay */
                                    #pdf-full-overlay > *:not(#printable-content) {
                                        display: none !important;
                                    }
                                    
                                    /* Afficher seulement le contenu à imprimer */
                                    #printable-content {
                                        position: static !important;
                                        left: auto !important;
                                        top: auto !important;
                                        width: 100% !important;
                                        margin: 0 !important;
                                        padding: 0 !important;
                                        box-shadow: none !important;
                                        page-break-after: avoid !important;
                                        min-height: auto !important;
                                        background: white !important;
                                        display: block !important;
                                        visibility: visible !important;
                                    }
                                    
                                    /* Ajuster les tailles pour tenir sur une page */
                                    #printable-content h1 {
                                        font-size: 24px !important;
                                        margin-bottom: 15px !important;
                                    }
                                    
                                    #printable-content h3 {
                                        font-size: 16px !important;
                                        margin: 10px 0 8px 0 !important;
                                    }
                                    
                                    #printable-content p {
                                        margin: 3px 0 !important;
                                        font-size: 12px !important;
                                    }
                                    
                                    #printable-content table {
                                        font-size: 11px !important;
                                        margin-bottom: 15px !important;
                                    }
                                    
                                    #printable-content th, #printable-content td {
                                        padding: 6px 4px !important;
                                    }
                                    
                                    /* Réduire les espaces */
                                    .info-grid {
                                        margin-bottom: 15px !important;
                                    }
                                    
                                    .status-section {
                                        margin-bottom: 15px !important;
                                        padding: 8px !important;
                                    }
                                    
                                    .financial-section {
                                        margin-bottom: 15px !important;
                                        padding: 15px !important;
                                    }
                                    
                                    .conditions-section {
                                        margin-top: 15px !important;
                                        padding: 15px !important;
                                    }
                                    
                                    .footer-section {
                                        margin-top: 15px !important;
                                        padding-top: 10px !important;
                                        font-size: 10px !important;
                                    }
                                    
                                    /* Éviter les coupures de page */
                                    .info-grid, .status-section, table, .financial-section, .conditions-section {
                                        page-break-inside: avoid;
                                    }
                                    
                                    /* S'assurer qu'il n'y a qu'une seule page */
                                    html, body {
                                        height: auto !important;
                                        overflow: visible !important;
                                    }
                                }
                                
                                /* Styles normaux pour l'écran (inchangés) */
                                .info-grid {
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 20px;
                                    margin-bottom: 30px;
                                }
                            </style>
                            
                            <!-- En-tête -->
                            <div style="text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px;">
                                <h1 style="margin: 0; font-size: 32px; color: #1f2937;">🧾 DEVIS COMMERCIAL NOVA</h1>
                                <p style="margin: 10px 0 0 0; font-size: 16px; color: #6b7280;">
                                    Document contractuel - Validité 30 jours
                                </p>
                            </div>
                            
                            <!-- Informations principales -->
                            <div class="info-grid">
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <h3 style="margin: 0 0 15px 0; color: #1f2937;">📋 Informations Devis</h3>
                                    <p style="margin: 5px 0;"><strong>Numéro :</strong> ${quoteNumber}</p>
                                    <p style="margin: 5px 0;"><strong>Date :</strong> ${quoteDate}</p>
                                    <p style="margin: 5px 0;"><strong>Validité :</strong> 30 jours</p>
                                    <p style="margin: 5px 0;"><strong>Statut :</strong> ${result.quote_status || 'Créé'}</p>
                                </div>
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #22c55e;">
                                    <h3 style="margin: 0 0 15px 0; color: #1f2937;">🏢 Informations Client</h3>
                                    <p style="margin: 5px 0;"><strong>Nom :</strong> ${clientName}</p>
                                    <p style="margin: 5px 0;"><strong>Code client :</strong> ${result.client?.account_number || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>ID Salesforce :</strong> ${result.client?.salesforce_id || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>SAP DocNum :</strong> ${result.sap_doc_num || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Statut stock -->
                            <div class="status-section" style="
                                padding: 15px; 
                                margin-bottom: 25px; 
                                border-radius: 8px; 
                                border-left: 4px solid ${result.all_products_available ? '#22c55e' : '#f59e0b'}; 
                                background: ${result.all_products_available ? '#f0fdf4' : '#fef3c7'};
                                color: ${result.all_products_available ? '#15803d' : '#92400e'};
                            ">
                                <strong>${result.all_products_available ? '✅ Produits en stock' : '⚠️ Produits en rupture'}</strong> - 
                                Délai de livraison : ${result.all_products_available ? '5-7 jours ouvrés' : '3 semaines sous réserve'}
                            </div>
                            
                            <!-- Tableau produits -->
                            <h3 style="color: #1f2937; margin-bottom: 15px;">📦 Détail des Produits</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 12px 8px; border: 1px solid #333; text-align: left;">Code Produit</th>
                                        <th style="padding: 12px 8px; border: 1px solid #333; text-align: left;">Désignation</th>
                                        <th style="padding: 12px 8px; border: 1px solid #333; text-align: center;">Quantité</th>
                                        <th style="padding: 12px 8px; border: 1px solid #333; text-align: right;">Prix Unit. HT</th>
                                        <th style="padding: 12px 8px; border: 1px solid #333; text-align: right;">Total HT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${productsHTML}
                                </tbody>
                            </table>
                            
                            <!-- Récapitulatif financier -->
                            <div style="float: right; min-width: 300px; margin-bottom: 40px;">
                                <div class="financial-section" style="border: 2px solid #667eea; padding: 20px; background: #f8fafc; border-radius: 8px;">
                                    <h4 style="margin: 0 0 15px 0; text-align: center; color: #1f2937;">💰 Récapitulatif Financier</h4>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                        <span><strong>Total HT :</strong></span>
                                        <span style="font-family: monospace;"><strong>${totalAmount.toFixed(2)} ${currency}</strong></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                        <span>TVA (20%) :</span>
                                        <span style="font-family: monospace;">${(totalAmount * 0.2).toFixed(2)} EUR</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-top: 2px solid #059669; margin-top: 10px; font-size: 18px; font-weight: bold; color: #059669;">
                                        <span>TOTAL TTC :</span>
                                        <span style="font-family: monospace;">${(totalAmount * 1.2).toFixed(2)} EUR</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="clear: both;"></div>
                            
                            <!-- Conditions commerciales -->
                            <div class="conditions-section" style="background: #fffbeb; padding: 20px; border-left: 4px solid #f59e0b; border-radius: 8px; margin-top: 30px;">
                                <h4 style="margin: 0 0 15px 0; color: #92400e;">📋 Conditions Commerciales</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px; color: #78350f;">
                                    <div>
                                        • <strong>Validité :</strong> 30 jours à compter de la date d'émission<br>
                                        • <strong>Délai :</strong> ${result.all_products_available ? '5-7 jours ouvrés après confirmation' : '3 semaines sous réserve de disponibilités fabricant'}
                                    </div>
                                    <div>
                                        • <strong>Conditions de paiement :</strong> 30 jours net<br>
                                        • <strong>Prix :</strong> Exprimés en euros hors taxes
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pied de page -->
                            <div class="footer-section" style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #6b7280;">
                                <em>Devis généré automatiquement par NOVA Middleware - ${new Date().toLocaleString('fr-FR')}</em>
                            </div>
                        </div>
            `;
            
            // Ajouter au DOM
            document.body.appendChild(pdfOverlay);
            
            // Fonction pour fermer
            window.closePDFFullscreen = function() {
                document.body.removeChild(pdfOverlay);
                delete window.closePDFFullscreen;
            };
            
            console.log("✅ Aperçu PDF affiché en plein écran");
            showNotification('Aperçu PDF ouvert ! Cliquez sur "Imprimer PDF" pour sauvegarder', 'success');
        }
        function generatePDFFromButton(button) {
            try {
                const resultData = JSON.parse(button.getAttribute('data-result'));
                console.log("📄 Données récupérées pour PDF:", resultData);
                generatePDFWorking(resultData);
            } catch (error) {
                console.error("❌ Erreur récupération données PDF:", error);
                showNotification('Erreur lors de la génération du PDF', 'error');
            }
        }
        function showAdvancedInterface() {
            // Créer la modal pour l'interface avancée
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    width: 100%;
                    max-width: 1200px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 60px rgba(0,0,0,0.3);
                ">
                    <div style="
                        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 20px 20px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h2 style="margin: 0; font-size: 1.5em;">⚙️ Interface Avancée NOVA</h2>
                        <button onclick="closeAdvancedInterface()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 1.2em;
                        ">✕</button>
                    </div>
                    <div id="advancedContent" style="padding: 30px;">
                        <div style="text-align: center; padding: 40px;">
                            <div style="
                                display: inline-block;
                                width: 50px;
                                height: 50px;
                                border: 5px solid #e2e8f0;
                                border-radius: 50%;
                                border-top-color: #667eea;
                                animation: spin 1s ease-in-out infinite;
                                margin-bottom: 20px;
                            "></div>
                            <p style="color: #64748b; font-size: 1.1em;">Chargement de l'interface avancée...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.id = 'advancedModal';
            
            // Charger l'interface avancée après un délai
            setTimeout(() => {
                loadAdvancedInterface();
            }, 1500);
            
            showNotification('Ouverture de l\'interface avancée...', 'success');
        }

        function closeAdvancedInterface() {
            const modal = document.getElementById('advancedModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }

        function loadAdvancedInterface() {
            const content = document.getElementById('advancedContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                    <!-- Zone principale -->
                    <div>
                        <div style="background: #f8fafc; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                💬 Saisie Avancée
                            </h3>
                            <textarea style="
                                width: 100%;
                                height: 120px;
                                padding: 15px;
                                border: 2px solid #e2e8f0;
                                border-radius: 8px;
                                font-family: inherit;
                                resize: vertical;
                            " placeholder="Saisie avec fonctionnalités avancées..."></textarea>
                        </div>

                        <!-- Assistants -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Client -->
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                                <h4 style="margin-bottom: 15px; color: #2c3e50;">🏢 Sélection Client</h4>
                                <input type="text" placeholder="🔍 Rechercher client..." onkeyup="searchClients(this.value)" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #e2e8f0;
                                    border-radius: 6px;
                                    margin-bottom: 10px;
                                ">
                                <div style="max-height: 150px; overflow-y: auto;" id="clientsContainer">
                                    <div style="padding: 20px; text-align: center; color: #64748b;">
                                        Chargement des clients...
                                    </div>
                                </div>
                                <button onclick="showCreateClientForm()" style="
                                    width: 100%;
                                    padding: 8px;
                                    background: #f1f5f9;
                                    border: 1px solid #e2e8f0;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    margin-top: 10px;
                                ">➕ Créer nouveau client</button>
                            </div>

                        <!-- Produits -->
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                                <h4 style="margin-bottom: 15px; color: #2c3e50;">📦 Sélection Produits</h4>
                                <input type="text" placeholder="🔍 Rechercher produits..." onkeyup="searchProducts(this.value)" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #e2e8f0;
                                    border-radius: 6px;
                                    margin-bottom: 10px;
                                ">
                                <div style="max-height: 150px; overflow-y: auto;" id="productsContainer">
                                    <div style="padding: 20px; text-align: center; color: #64748b;">
                                        Chargement des produits...
                                    </div>
                                </div>
                                <button onclick="showCreateProductForm()" style="
                                    width: 100%;
                                    padding: 8px;
                                    background: #f1f5f9;
                                    border: 1px solid #e2e8f0;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    margin-top: 10px;
                                ">➕ Ajouter produit personnalisé</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div>
                        <!-- Dashboard -->
                        <div style="background: #f8fafc; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">📊 Aperçu Temps Réel</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #64748b; font-size: 0.9em;">💰 Montant estimé</span>
                                <span style="font-weight: 600;" id="advancedAmount">0 € HT</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #64748b; font-size: 0.9em;">📦 Disponibilité</span>
                                <span style="font-weight: 600;" id="advancedAvailability">En attente</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #64748b; font-size: 0.9em;">⏱️ Délai livraison</span>
                                <span style="font-weight: 600;">5-7 jours</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #64748b; font-size: 0.9em;">🎯 Marge estimée</span>
                                <span style="font-weight: 600;">23%</span>
                            </div>
                        </div>

                        <!-- Actions rapides -->
                        <div style="background: #f8fafc; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">🚀 Actions Rapides</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button style="padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.8em;" onclick="advancedAction('duplicate')">📋 Dupliquer</button>
                                <button style="padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.8em;" onclick="advancedAction('contact')">📞 Contact</button>
                                <button style="padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.8em;" onclick="advancedAction('email')">📧 Email</button>
                                <button style="padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.8em;" onclick="advancedAction('template')">💾 Modèle</button>
                            </div>
                        </div>

                        <!-- Mode démo -->
                        <div style="background: #f8fafc; border-radius: 15px; padding: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">🎪 Scénarios Démo</h4>
                            <button onclick="loadAdvancedDemo('scenario1')" style="width: 100%; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; margin-bottom: 6px; font-size: 0.9em;">🎯 Client existant</button>
                            <button onclick="loadAdvancedDemo('scenario2')" style="width: 100%; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; margin-bottom: 6px; font-size: 0.9em;">🆕 Nouveau client</button>
                            <button onclick="loadAdvancedDemo('scenario3')" style="width: 100%; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; margin-bottom: 6px; font-size: 0.9em;">📦 Multi-produits</button>
                            <button onclick="loadAdvancedDemo('scenario4')" style="width: 100%; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.9em;">⚠️ Rupture stock</button>
                        </div>
                    </div>
                </div>

                <!-- Bouton génération dans l'interface avancée -->
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="generateAdvancedQuote()" style="
                        padding: 15px 40px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1em;
                        font-weight: 600;
                        cursor: pointer;
                        margin-right: 15px;
                    ">🚀 Générer Devis Avancé</button>
                    <button onclick="closeAdvancedInterface()" style="
                        padding: 15px 30px;
                        background: #f1f5f9;
                        color: #475569;
                        border: 1px solid #e2e8f0;
                        border-radius: 10px;
                        font-size: 1em;
                        cursor: pointer;
                    ">Retour Simple</button>
                </div>
            `;
            
            // Charger les clients au démarrage de l'interface avancée avec vérification DOM
            setTimeout(() => {
                // Vérifier que les éléments DOM existent avant de charger
                const clientsContainer = document.getElementById('clientsContainer');
                const productsContainer = document.getElementById('productsContainer');
                
                console.log('Vérification DOM:', { 
                    clientsContainer: !!clientsContainer, 
                    productsContainer: !!productsContainer 
                });
                
                if (clientsContainer) {
                    loadRealClients();
                } else {
                    console.error('❌ clientsContainer non trouvé - nouvel essai...');
                    setTimeout(() => loadRealClients(), 500);
                }
                
                if (productsContainer) {
                    loadRealProducts();
                } else {
                    console.error('❌ productsContainer non trouvé - nouvel essai...');
                    setTimeout(() => loadRealProducts(), 500);
                }
            }, 200); // Augmenté de 100ms à 200ms
        }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function sendQuoteByEmail() {
        // Créer modal d'envoi d'email
        const emailModal = document.createElement('div');
        emailModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        `;
        
        emailModal.innerHTML = `
            <div style="
                background: white;
                border-radius: 15px;
                width: 100%;
                max-width: 500px;
                padding: 30px;
                box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                ">
                    <h3 style="margin: 0; color: #2c3e50;">Envoyer le Devis par Email</h3>
                    <button onclick="closeEmailModal()" style="
                        background: #f1f5f9;
                        border: none;
                        color: #64748b;
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1.2em;
                    ">×</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Email du client :</label>
                    <input type="email" id="clientEmail" value="contact@edge-communications.fr" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #e2e8f0;
                        border-radius: 6px;
                        font-size: 1em;
                    "/>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Objet :</label>
                    <input type="text" id="emailSubject" value="Devis NOVA-${new Date().getTime().toString().slice(-6)}" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #e2e8f0;
                        border-radius: 6px;
                        font-size: 1em;
                    "/>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Message :</label>
                    <textarea id="emailMessage" style="
                        width: 100%;
                        height: 100px;
                        padding: 10px;
                        border: 1px solid #e2e8f0;
                        border-radius: 6px;
                        font-size: 1em;
                        resize: vertical;
                        font-family: inherit;
                    ">Bonjour,

Veuillez trouver ci-joint votre devis généré automatiquement via NOVA.

Détails du devis :
- Montant total : ${document.querySelector('#resultContent') && document.querySelector('#resultContent').textContent.includes('€') ? (document.querySelector('#resultContent').textContent.match(/\d+[,.]?\d*\s*€/) || ['40,000.00 €'])[0] : '40,000.00 €'}
- Validité : 30 jours

N'hésitez pas à nous contacter pour toute question.

Cordialement,
L'équipe commerciale</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="sendEmailNow()" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                        ">📧 Envoyer</button>
                        <button onclick="closeEmailModal()" style="
                            flex: 1;
                            padding: 12px 20px;
                            background: #f1f5f9;
                            color: #475569;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                        ">Annuler</button>
                    </div>
                </div>
            `; // <-- properly closed template literal
            
            document.body.appendChild(emailModal);
            emailModal.id = 'emailModal';
            
            // Focus sur l'email
            setTimeout(() => {
                document.getElementById('clientEmail').focus();
            }, 100);
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }

        function sendEmailNow() {
            const email = document.getElementById('clientEmail').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (!email || !subject) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            // Simulation d'envoi d'email réaliste
            closeEmailModal();
            showNotification('Envoi en cours...', 'success');
            
            setTimeout(() => {
                showNotification(`Email envoyé avec succès à ${email} !`, 'success');
                
                // Optionnel : ouvrir le client email par défaut
                const mailto = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
                window.open(mailto, '_blank');
            }, 2000);
        }


        function closePDFModal() {
            const modal = document.getElementById('pdfModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        }

        function downloadPDF() {
            showNotification('Génération du PDF en cours...', 'success');
            
            // Simulation du téléchargement
            setTimeout(() => {
                // Créer un lien de téléchargement simulé
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwovUGFnZXMgMiAwIFIKPj4KZW5kb2JqCjIgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFszIDAgUl0KL0NvdW50IDEKPD4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKL1BhcmVudCAyIDAgUgovTWVkaWFCb3ggWzAgMCA2MTIgNzkyXQovQ29udGVudHMgNCAwIFIKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL0xlbmd0aCA0NAo+PgpzdHJlYW0KQVQKL0YxIDEyIFRmCjcyIDcyMCBUZApEZXZpcyBOT1ZBLTEyMzQ1NgpFVApFVApzdHJlYW0KZW5kb2JqCnhyZWYKMCA1CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDAwOSAwMDAwMCBuIAowMDAwMDAwMDU4IDAwMDAwIG4gCjAwMDAwMDAxMTUgMDAwMDAgbiAKMDAwMDAwMDE5NiAwMDAwMCBuIAp0cmFpbGVyCjw8Ci9TaXplIDUKL1Jvb3QgMSAwIFIKPj4Kc3RhcnR4cmVmCjI5MAolJUVPRgo=';
                link.download = `Devis_NOVA_${new Date().getTime().toString().slice(-6)}.pdf`;
                link.click();
                
                closePDFModal();
                showNotification('PDF téléchargé avec succès !', 'success');
            }, 1500);
        }

        function openPDFInNewTab() {
            // Ouvrir une page simulée du PDF
            const pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Devis NOVA - ${new Date().getTime().toString().slice(-6)}</title>
                    <style>
                        body { font-family: Arial; padding: 40px; background: #f5f5f5; }
                        .pdf-container { background: white; padding: 40px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
                        .header { text-align: center; border-bottom: 2px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
                        .section { margin-bottom: 20px; }
                        .total { background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; }
                    </style>
                </head>
                <body>
                    <div class="pdf-container">
                            <h1>🚀 DEVIS NOVA</h1>
                            <p>N° NOVA-${new Date().getTime().toString().slice(-6)}</p>
                            <p>Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                        
                        <div class="section">
                            <h3>👤 Informations Client</h3>
                            <p><strong>Nom :</strong> Edge Communications</p>
                            <p><strong>ID Salesforce :</strong> 001gL000005OYCDQA4</p>
                            <p><strong>Code SAP :</strong> CEDGEC1058</p>
                        </div>
                        
                        <div class="section">
                            <h3>📦 Détails des Produits</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Code</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Désignation</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Qté</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Prix Unit.</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">A00001</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">Connecteur USB-C</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">100</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">400,00 €</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">40 000,00 €</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="total">
                            <h3>💰 Total du Devis</h3>
                            <p><strong>Montant HT : 40 000,00 €</strong></p>
                            <p><strong>TVA (20%) : 8 000,00 €</strong></p>
                            <p style="font-size: 1.2em;"><strong>TOTAL TTC : 48 000,00 €</strong></p>
                        </div>
                        
                        <div class="section">
                            <h3>📋 Conditions</h3>
                            <p>• Validité du devis : 30 jours</p>
                            <p>• Délai de livraison : 5-7 jours ouvrés</p>
                            <p>• Paiement : 30 jours net</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 40px; color: #64748b;">
                            <p><em>Devis généré automatiquement par NOVA - ${new Date().toLocaleString('fr-FR')}</em></p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(pdfContent);
            newWindow.document.close();
            
            closePDFModal();
            showNotification('PDF ouvert dans un nouvel onglet !', 'success');
        }

        // Correction newQuote - Réinitialisation complète
        function newQuote() {
            console.log("🔄 Réinitialisation interface");
            
            // Masquer résultats
            const resultPanel = document.getElementById('resultPanel');
            if (resultPanel) resultPanel.style.display = 'none';
            
            // Masquer progression
            const processing = document.getElementById('processing');
            if (processing) processing.style.display = 'none';
            
            // Réactiver bouton
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = false;
            
            // Vider champ
            const promptInput = document.getElementById('mainInput');
            if (promptInput) {
                promptInput.value = '';
                promptInput.focus();
            }
            
            // Supprimer notifications
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(n => n.remove());
        }

        // Protection event listeners - Une seule assignation
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🔄 Initialisation interface...");
            
            // Nettoyer les anciens listeners
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                // Supprimer tous les anciens listeners en clonant l'élément
                const newBtn = generateBtn.cloneNode(true);
                generateBtn.parentNode.replaceChild(newBtn, generateBtn);
                
                // Assigner UN SEUL listener
                document.getElementById('generateBtn').onclick = function() {
                    console.log("🚀 Clic bouton détecté");
                    generateQuote();
                };
                
                console.log("✅ Event listener unique assigné");
            }
        });

        async function loadRealClients(searchTerm = '') {
            try {
                const response = await fetch(`/clients/search_clients_advanced?q=${encodeURIComponent(searchTerm)}&limit=10`);
                const data = await response.json();
                // Debug: afficher la réponse complète
                console.log('Réponse API clients:', data);

                const clientsContainer = document.getElementById('clientsContainer');

                // Vérifier d'abord s'il y a une erreur API
                if (!data.success) {
                    clientsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #ef4444;">
                            <div style="font-size: 2em; margin-bottom: 10px;">⚠️</div>
                            Erreur de chargement des clients
                            <div style="font-size: 0.8em; margin-top: 5px; color: #6b7280;">
                                ${data.error || 'Vérifiez la connexion Salesforce'}
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (data.success && data.clients.length > 0) {
                    clientsContainer.innerHTML = data.clients.map(client => `
                        <div onclick="selectAdvancedClient('${client.name}', '${client.id}')" style="
                            padding: 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-bottom: 8px;
                            border: 1px solid #e2e8f0;
                            transition: all 0.2s;
                            background: white;
                        " onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#3b82f6'" 
                        onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <strong style="color: #1f2937; font-size: 0.95em;">${client.name}</strong>
                                ${client.account_number ? `<span style="font-size: 0.8em; color: #6b7280; background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">${client.account_number}</span>` : ''}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Code client :</strong> ${client.account_number || 'N/A'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Salesforce ID :</strong> ${client.id || 'N/A'}
                            </div>
                            <div style="font-size: 0.85em; color: #6b7280;">
                                🏢 ${client.type_display}
                            </div>
                            ${client.phone ? `<div style="font-size: 0.8em; color: #9ca3af; margin-top: 4px;">📞 ${client.phone}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    clientsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #64748b;">
                            <div style="font-size: 2em; margin-bottom: 10px;">🔍</div>
                            ${searchTerm ? `Aucun client trouvé pour "${searchTerm}"` : 'Aucun client disponible'}
                        </div>
                    `;
                }
                
                // Debug : afficher le nombre de clients chargés
                console.log(`Clients chargés: ${data.clients?.length || 0}`);
                
            } catch (error) {
                console.error('Erreur chargement clients:', error);
                document.getElementById('clientsContainer').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <div style="font-size: 2em; margin-bottom: 10px;">⚠️</div>
                        Erreur de chargement des clients
                        <div style="font-size: 0.8em; margin-top: 5px; color: #6b7280;">
                            Vérifiez la connexion Salesforce
                        </div>
                    </div>
                `;
            }
        }
        async function loadRealProducts(searchTerm = '') {
            try {
                const response = await fetch(`/products/search_products_advanced?q=${encodeURIComponent(searchTerm)}&limit=10`);
                const data = await response.json();

                const productsContainer = document.getElementById('productsContainer');

                if (data.success && data.products.length > 0) {
                    productsContainer.innerHTML = data.products.map(product => `
                        <div onclick="selectAdvancedProduct('${product.item_code}', '${product.item_name}', ${product.price})" style="
                            padding: 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-bottom: 8px;
                            border: 1px solid #e2e8f0;
                            transition: all 0.2s;
                            background: white;
                        " onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#3b82f6'" 
                        onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <strong style="color: #1f2937; font-size: 0.95em;">${product.display_text}</strong>
                                ${product.price > 0 ? `<span style='font-size: 0.9em; color: #059669;'>${product.price_display}</span>` : ''}
                            </div>
                            <div style="font-size: 0.85em; color: ${product.availability_color};">
                                ${product.availability_text}
                            </div>
                        </div>
                    `).join('');
                } else {
                    productsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #64748b;">
                            <div style="font-size: 2em; margin-bottom: 10px;">🔍</div>
                            ${searchTerm ? `Aucun produit trouvé pour "${searchTerm}"` : 'Aucun produit disponible'}
                        </div>
                    `;
                }

                console.log(`Produits chargés: ${data.products?.length || 0}`);

            } catch (error) {
                console.error('Erreur chargement produits:', error);
                document.getElementById('productsContainer').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <div style="font-size: 2em; margin-bottom: 10px;">⚠️</div>
                        Erreur de chargement des produits
                        <div style="font-size: 0.8em; margin-top: 5px; color: #6b7280;">
                            Vérifiez la connexion SAP
                        </div>
                    </div>
                `;
            }
        }

        // Recherche en temps réel
        function searchClients(searchTerm) {
            clearTimeout(window.clientSearchTimeout);
            window.clientSearchTimeout = setTimeout(() => {
                loadRealClients(searchTerm);
            }, 300); // Délai de 300ms pour éviter trop d'appels
        }

        // Sélection d'un client
        function selectAdvancedClient(clientName, clientId) {
            // Mettre à jour l'affichage de sélection
            showNotification(`Client sélectionné: ${clientName}`, 'success');
            
            // Stocker la sélection
            window.selectedClient = { name: clientName, id: clientId };
            
            // Optionnel : mettre à jour l'aperçu
            updateAdvancedPreview();
        }
        function showError(errorData) {
            console.error("❌ Erreur:", errorData);
            
            // 🔍 DÉTECTION DU TYPE D'ERREUR SPÉCIAL
            if (typeof errorData === 'object' && errorData.error_type === 'duplicates_detected') {
                console.log("🛡️ Doublons détectés - Affichage interface de résolution");
                
                // Masquer le processing
                const processing = document.getElementById('processing');
                if (processing) processing.style.display = 'none';
                
                // Réactiver bouton
                const generateBtn = document.getElementById('generateBtn');
                if (generateBtn) generateBtn.disabled = false;
                
                // Afficher l'interface de résolution des doublons
                const originalPrompt = document.getElementById('mainInput')?.value?.trim() || '';
                showDuplicatesResolutionModal(errorData.error_details, originalPrompt);
                return;
            }
            
            // Extraire le message selon le format
            const message = typeof errorData === 'object' ? 
                (errorData.message || errorData.error || JSON.stringify(errorData)) : 
                errorData;
            
            // Masquer indicateur de progression
            const processing = document.getElementById('processing');
            if (processing) processing.style.display = 'none';
            
            // Réactiver bouton
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = false;
            
            // Afficher message d'erreur
            const resultPanel = document.getElementById('resultPanel');
            if (resultPanel) {
                resultPanel.style.display = 'block';
                const resultContent = document.getElementById('resultContent');
                if (resultContent) {
                    resultContent.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="color: #dc2626; font-size: 2em; margin-bottom: 10px;">⚠️</div>
                            <h3 style="color: #dc2626; margin: 0 0 10px 0;">Erreur de génération</h3>
                            <p style="color: #7f1d1d; margin: 0;">${message}</p>
                            <button onclick="newQuote()" style="
                                margin-top: 15px;
                                padding: 8px 16px;
                                background: #dc2626;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">Réessayer</button>
                        </div>
                    `;
                }
            }
            
            // Notification d'erreur
            showNotification(message, 'error');
        }
        // Afficher l'interface de résolution des doublons
        function showDuplicatesResolutionModal(duplicateInfo, originalPrompt) {
            console.log("🔍 Affichage interface résolution doublons", duplicateInfo);
            
            const modal = document.createElement('div');
            modal.id = 'duplicatesModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;
            
            const draftQuotes = duplicateInfo.draft_quotes || [];
            const recentQuotes = duplicateInfo.recent_quotes || [];
            const warnings = duplicateInfo.warnings || [];
            const clientName = duplicateInfo.client_name || 'ce client';
            const draftCount = duplicateInfo.existing_drafts || 0;
            const recentCount = duplicateInfo.recent_quotes || 0;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    max-width: 800px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <!-- En-tête -->
                    <div style="
                        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 15px 15px 0 0;
                        text-align: center;
                    ">
                        <h2 style="margin: 0 0 10px 0; color: #2c3e50;">
                            🔍 Devis existants pour ${clientName}
                        </h2>
                        <p style="margin: 0 0 20px 0; color: #7f8c8d;">
                            ${draftCount} brouillon(s) et ${recentCount} devis récent(s) trouvé(s)
                        </p>
                    </div>
                    
                    <!-- Contenu -->
                    <div style="padding: 30px;">
                        <!-- Alertes -->
                        <div style="
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        ">
                            ${warnings.map(warning => `
                                <div style="margin-bottom: 8px; color: #856404;">
                                    ${warning}
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Devis brouillons -->
                        ${draftQuotes.length > 0 ? `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px;">📝 Devis en Brouillon</h3>
                                <div style="
                                    background: #f8f9fa;
                                    border-radius: 8px;
                                    padding: 15px;
                                    max-height: 200px;
                                    overflow-y: auto;
                                ">
                                    ${draftQuotes.map(quote => `
                                        <div style="
                                            background: white;
                                            border-radius: 6px;
                                            padding: 12px;
                                            margin-bottom: 10px;
                                            border-left: 4px solid #3498db;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                        " 
                                        onclick="selectQuoteForConsolidation('${quote.doc_entry || quote.id}')"
                                        onmouseover="this.style.backgroundColor='#e8f4f8'"
                                        onmouseout="this.style.backgroundColor='white'">
                                            <div style="font-weight: 600; color: #2c3e50;">
                                                Devis #${quote.doc_num || quote.doc_entry || quote.id}
                                            </div>
                                            <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 4px;">
                                                ${quote.customer_name || quote.card_name || 'Client'} - ${quote.total_amount || quote.doc_total || 'N/A'}€
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Devis récents -->
                        ${recentQuotes.length > 0 ? `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px;">🕒 Devis Récents</h3>
                                <div style="
                                    background: #f8f9fa;
                                    border-radius: 8px;
                                    padding: 15px;
                                    max-height: 150px;
                                    overflow-y: auto;
                                ">
                                    ${recentQuotes.map(quote => `
                                        <div style="
                                            background: white;
                                            border-radius: 6px;
                                            padding: 12px;
                                            margin-bottom: 10px;
                                            border-left: 4px solid #e67e22;
                                        ">
                                            <div style="font-weight: 600; color: #2c3e50;">
                                                Devis #${quote.doc_num || quote.doc_entry || quote.id}
                                            </div>
                                            <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 4px;">
                                                ${quote.customer_name || quote.card_name || 'Client'} - ${quote.doc_date || 'Date inconnue'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="text-align: center; margin-top: 30px;">
                            <p style="color: #7f8c8d; margin-bottom: 20px;">
                                Que souhaitez-vous faire ?
                            </p>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <!-- Créer nouveau -->
                                <button onclick="resolveDuplicates('create_new', '${originalPrompt.replace(/'/g, "\\'")}')" style="
                                    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
                                    color: white;
                                    border: none;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.2s;
                                " 
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'">
                                    ✅ Créer Nouveau<br>
                                    <small style="opacity: 0.8;">Ignorer les doublons</small>
                                </button>
                                
                                <!-- Consolider/Reprendre -->
                                <button onclick="resolveDuplicates('consolidate', '${originalPrompt.replace(/'/g, "\\'")}')" style="
                                    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                                    color: white;
                                    border: none;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'">
                                    📝 Reprendre un brouillon<br>
                                    <small style="opacity: 0.8;">Continuer un devis existant</small>
                                </button>
                                
                                <!-- Annuler -->
                                <button onclick="resolveDuplicates('cancel', '${originalPrompt.replace(/'/g, "\\'")}')" style="
                                    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
                                    color: white;
                                    border: none;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.2s;
                                "
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'">
                                    ❌ Annuler<br>
                                    <small style="opacity: 0.8;">Abandonner l'opération</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fermeture sur clic extérieur
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDuplicatesModal();
                }
            });
        }

        // Variables globales pour la sélection
        let selectedQuoteForConsolidation = null;

        function selectQuoteForConsolidation(quoteId) {
            selectedQuoteForConsolidation = quoteId;
            
            // Visuel de sélection
            document.querySelectorAll('[onclick^="selectQuoteForConsolidation"]').forEach(el => {
                el.style.backgroundColor = 'white';
                el.style.borderLeftColor = '#3498db';
            });
            
            event.target.closest('div').style.backgroundColor = '#e8f4f8';
            event.target.closest('div').style.borderLeftColor = '#27ae60';
            
            showNotification(`Devis ${quoteId} sélectionné pour consolidation`, 'success');
        }

        function resolveDuplicates(action, originalPrompt) {
            console.log(`🔧 Résolution doublons: ${action}`);
            
            if (action === 'consolidate' && !selectedQuoteForConsolidation) {
                showNotification('Veuillez sélectionner un devis à consolider', 'error');
                return;
            }
            
            if (action === 'cancel') {
                closeDuplicatesModal();
                showNotification('Opération annulée', 'success');
                return;
            }
            
            // Fermer le modal et traiter l'action
            closeDuplicatesModal();
            
            if (action === 'create_new') {
                showNotification('Création forcée en cours...', 'success');
                
                // Relancer generateQuote() avec un flag spécial pour forcer la création
                document.getElementById('mainInput').value = originalPrompt;
                
                // TODO: Appeler une version modifiée de generateQuote() qui ignore les doublons
                setTimeout(() => {
                    generateQuote(); // Pour l'instant, relance normal
                }, 1000);
                
            } else if (action === 'consolidate') {
                showNotification(`Consolidation avec devis ${selectedQuoteForConsolidation} en cours...`, 'success');
                // TODO: Implémenter la logique de consolidation
                setTimeout(() => {
                    showNotification('Fonctionnalité de consolidation en développement', 'error');
                }, 2000);
            }
        }

        function closeDuplicatesModal() {
            const modal = document.getElementById('duplicatesModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        document.body.removeChild(modal);
                    }
                }, 300);
            }
            selectedQuoteForConsolidation = null;
        }
        function newQuote() {
            // Réinitialiser l'interface
            const resultPanel = document.getElementById('resultPanel');
            if (resultPanel) resultPanel.style.display = 'none';
            
            const promptInput = document.getElementById('mainInput');
            if (promptInput) {
                promptInput.value = '';
                promptInput.focus();
            }
            
            console.log("🔄 Interface réinitialisée");
        }

        function showNotification(message, type = 'success') {
            // Supprimer notification existante
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #10b981;' : 'background: #dc2626;'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animation d'entrée
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-suppression
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>

</body>
</html>